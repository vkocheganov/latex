\chapter{Анализ стохастической последовательности $\boldsymbol{\{(\Gamma_i,  \varkappa_{i}), i \geqslant 0\}}$}						% Заголовок
% \addcontentsline{toc}{chapter}{Анализ кибернетической системы как стохастической последовательности}	% Добавляем его в оглавление
% \setcounter{chapter}{2}
% \setcounter{section}{0}

Исследуемая в работе управляющая система характеризуется следующими объектами:  обслуживающее устройство и четыре очереди. Последовательность 
 $\{(\Gamma_i,  \varkappa_i); i \geqslant 0\}$ служит математическим описанием этих объектов, где $ \varkappa_i = (\varkappa_{1, i},  \varkappa_{2, i},  \varkappa_{3, i},   \varkappa_{4, i})$. Глава~2 посвящена тем результатам,  которые удается получить для этой пятимерной последовательности,  несмотря на ее сложность: доказана марковость этой последовательности,  а также проведена классификация ее состояний по арифметическим свойствам переходных вероятностей. Эти результаты позволят далее в работе доказать марковость и провести классификацию состояний для последовательностей,  содержащих только часть из упомянутых пяти компонент.

\section[Свойство марковости последовательности $\{(\Gamma_i,  \varkappa_{i}), i \geqslant 0\}$]%
{Свойство марковости последовательности $\boldsymbol{\{(\Gamma_i,  \varkappa_{i}), i \geqslant 0\}}$}
Пусть $a$,  $b$,  $x^i \in \mathbb{Z}_+^4$,  $k_i=\overline{0,d}$,  $r_i=\overline{1,n_{k_i}}$,  $i=0$,  $1$,  $\ldots$. Введем следующие события:
\begin{equation}
A_i(k_i;r_i;x^i) = \{\omega\colon\Gamma_i=\Gamma^{(k_i, r_i)},  \varkappa_i=x^i\},  \quad  B_i(a;b) = \{\omega\colon\eta_i=a,  \xi_i=b\}, 
\label{A:definition}
\end{equation}
 для $i=0$,  $1$,  $\ldots$.
В этих обозначениях равенство \eqref{eta:xi:forgetProperty}  перепишется следующим образом:
\begin{equation}
\Pr (B_i(a;b) | \bigcap_{t=0}^{i} A_t(k_t;r_t;x^t)) = \Pr (B_i(a;b) |  A_i(k_i;r_i;x^i)).
\label{new:notation:eta:xi:forget}
\end{equation}
Сформулируем и докажем теорему о марковости последовательности 
$$\Mark.$$
\begin{theorem}
Пусть $\Gamma_0=\Gamma^{(k, r)}\in \Gamma$ и $\varkappa_0=x^0\in \mathbb{Z}_+^4$ фиксированы. Тогда последовательность $\Mark$ является однородной счетной цепью Маркова. 
\end{theorem}

\begin{proof}
Для доказательства достаточно показать,  что 
\begin{multline}
\Pr \Bigl( A_{i+1}(k_{i+1};r_{i+1};x^{i+1})\, \,  \Bigl|\bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr.\Bigr) = \\ = \Pr \Bigl( A_{i+1}(k_{i+1};r_{i+1};x^{i+1})\, \,   \Bigl|A_i(k_i;r_i;x^{i})\Bigr.\Bigr)
\label{markovToProve}
\end{multline}
для $x^t \in {\mathbb Z}_+^4$ и $k_t$,  $r_t$ таких,  что $\Gamma^{(k_t, r_t)}\in \Gamma$ и $\Pr \Bigl(\,  \bigcap\limits_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr)>0 $.

Рассмотрим сначала левую часть равенства \eqref{markovToProve}. По формуле полной вероятности получим
\begin{multline}
\Pr \Bigl( A_{i+1}(k_{i+1};r_{i+1};x^{i+1}) \, \,  \Bigl|\bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr.\Bigr) 
= \sum_{\substack{a\in Z^4_+, \\ b\in Z^4_+}}\Pr \Bigl( B_i(a;b) \, \,  \Bigl|\bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr.\Bigr)\times\\
\times \Pr \Bigl( A_{i+1}(k_{i+1};r_{i+1};x^{i+1}) \, \,  \Bigl|B_i(a;b) \cap \bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr.\Bigr).
\label{markovProof}
\end{multline}
Из равенства \eqref{new:notation:eta:xi:forget} следует,  что вероятность  $\Pr \Bigl( B_i(a;b) \, \,   \Bigl| \bigcap\limits_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr)$ не зависит от значений $k_t$,  $r_t$,  $x^{t}$,  $t=\overline{0, i-1}$.
Далее,  из соотношений \eqref{gammaFunc},  \eqref{queuesFunc} и \eqref{FourthFunc} можно заметить,  что случайный элемент $\Gamma_{i+1}$ и случайный вектор $\varkappa_{i+1}$ функционально выражаются через $\Gamma_i$,  $\varkappa_i$,  $\eta_i$ и $\xi_i$,  поэтому 
\begin{multline*}
\Pr \Bigl( A_{i+1}(k_{i+1};r_{i+1};x^{i+1})\, \,   \Bigl|B_i(a;b) \cap \bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t})\Bigr.\Bigr) =\\= \Pr ( \tilde{A}_{i+1} \, \,  |B_i(a;b) \cap \bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t})),     
\end{multline*}
при $\Pr (B_i(a;b) \cap \bigcap_{t=0}^{i} A_t(k_t;r_t;x^{t}))>0$,  где 
\begin{multline*}
\tilde{A}_{i+1} = \{\omega\colon\Gamma^{(k_{i+1},  r_{i+1})}=h(\Gamma^{(k_i,  r_i)},  x_{3,  i}),  x_{j,  i+1}=\max\{0, x_{j,  i}+a_{j}-b_{j}\},  j=\overline{1,  3}, \\ x_{4,  i+1}=x_{4,  i}+a_{4}-a_2\}.
\end{multline*}
Ясно,  что событие $\tilde{A}_{i+1}$ при наступлении событий $B_i(a; b)$ и $A_i(k_i; r_i; x^{i})$ является либо достоверным,  либо невозможным событием.
%(k_{i+1};r_{i+1};x^{i+1})
Таким образом,  подставляя выражения
\begin{equation*}
\Pr \Bigl( B_i(a; b) \, \,  \Bigl|\bigcap_{t=0}^{i} A_t(k_t; r_t; x^{t})\Bigr.\Bigr) = \\
\Pr \Bigl( B_i(a; b)\, \,   \Bigl| A_i(k_i; r_i; x^{i})\Bigr.\Bigr)
\end{equation*}
и 
\begin{multline*}
\Pr \Bigl( A_{i+1}(k_{i+1}; r_{i+1}; x^{i+1})\, \,   \Bigl|B_i(a; b) \cap \bigcap_{t=0}^{i} A_t(k_t; r_t; x^{t})\Bigr.\Bigr) = \\
=\Pr \Bigl( A_{i+1}(k_{i+1}; r_{i+1}; x^{i+1}) \, \,  \Bigl|B_i(a;b) \cap A_i(k_i; r_i; x^{i})\Bigr.\Bigr)
\end{multline*}
в выражение \eqref{markovProof},  получим
\begin{multline}
\Pr \Bigl( A_{i+1}(k_{i+1}; r_{i+1}; x^{i+1})\, \,   \Bigl|\bigcap_{t=0}^{i} A_t(k_t; r_t; x^{t})\Bigr.\Bigr) =\displaybreak[0]\\
= \sum_{a\in Z^4_+,  b\in Z^4_+} \Pr \Bigl( B_i(a;b) \, \,  \Bigl| A_i(k_i; r_i; x^{i})\Bigr.\Bigr) \times\displaybreak[0]\\
\times \Pr \Bigl( A_{i+1}(k_{i+1}; r_{i+1}; x^{i+1}) \, \,   \Bigl|B_i(a; b) \cap A_i(k_i; r_i; x^{i})\Bigr.\Bigr).
\label{left:mark:full}
\end{multline}
По формуле полной вероятности раскроем правую часть равенства \eqref{markovToProve}:
\begin{multline}
\Pr \Bigl( A_{i+1}(k_{i+1};r_{i+1};x^{i+1}) \, \,  \Bigl|A_i(k_i; r_i; x^{i})\Bigr.\Bigr)=\\
=\sum_{a\in Z^4_+,  b\in Z^4_+} \Pr \Bigl( B_i(a; b) \, \,  \Bigl| A_i(k_i; r_i; x^{i})\Bigr.\Bigr) \times\displaybreak[0]\\
\times \Pr \Bigl( A_{i+1}(k_{i+1}; r_{i+1}; x^{i+1})\, \,   \Bigl|B_i(a; b) \cap A_i(k_i; r_i; x^{i})\Bigr.\Bigr).
\label{right:mark:full}
\end{multline}
Таким образом,  из равенств \eqref{left:mark:full} и \eqref{right:mark:full} следует 
равенство \eqref{markovToProve}.
\end{proof}

Естественным теперь поставить вопрос о том,  какие из компонент марковской цепи $\Mark$ также образуют марковскую цепь. Из формулы \eqref{gammaFunc} видно,  что состояние прибора $\Gamma_i$ влияет на то,  каким будет следующее состояние $\Gamma_{i+1}$ и,  следовательно,  каким будет его продолжительность. Продолжительность нахождения прибора в конкретном состоянии влияет на то,  какое количество требований успеет поступить по очередям $O_1$,  $O_2$,  $O_3$ и $O_4$. Также из формулы \eqref{gammaFunc} следует,  что $\Gamma_{i+1}$ зависит также от состояния $\varkappa_{3, i}$ очереди $O_3$. Оказывается,  что в смысле марковского свойства последовательность $\MarkThree$ является самодостаточной.

По аналогии с предыдущим утверждением,  докажем марковость последовательности $\MarkThree$,  описывающую динамику изменения состояния обслуживающего устройства и низкоприоритетной очереди $O_3$.
\begin{theorem}
Пусть $\Gamma_0=\Gamma^{(k, r)}\in \Gamma$ и $\varkappa_{3, 0}=x_{3, 0}\in \mathbb{Z}_+$ фиксированы. Тогда последовательность $\MarkThree$ является однородной счетной цепью Маркова.
\label{markov:theorem:three}
\end{theorem}
\begin{proof}
Для доказательства необходимо проверить равенство:
\begin{multline}
\Pr (\{ \omega\colon \Gamma_{i+1} =\Gamma^{(k_{i+1},  r_{i+1})}, \varkappa_{3,  i+1} = x_{3,  i+1}\} |\cap_{t=0}^{i}\{\omega\colon  \Gamma_t=\Gamma^{(k_t, r_t)},  \varkappa_{3, t}=x_{3, t}\}) = \\
= \Pr (\{ \omega\colon \Gamma_{i+1} =\Gamma^{(k_{i+1}, r_{i+1})}, \varkappa_{3, i+1} = x_{3, i+1}\} |\{\omega\colon  \Gamma_i=\Gamma^{(k_i, r_i)},  \varkappa_{3, i}=x_{3, i}\})
    \label{marktoprove:third}
\end{multline}
Действительно,  поскольку $\Gamma_{i+1}$ функционально выражается через $\Gamma_i$ и $\varkappa_{3, i}$ (см. условие \eqref{gammaFunc}),  то
\begin{multline*}
\Pr (\{ \omega\colon \Gamma_{i+1} =\Gamma^{(k_{i+1}, r_{i+1})}, \varkappa_{3, i+1} = x_{3, i+1}\} |\cap_{t=0}^{i}\{\omega\colon  \Gamma_t=\Gamma^{(k_t, r_t)},  \varkappa_t=x^t\})=\\
=\delta_{\Gamma^{(k_{i+1}, r_{i+1})}, h(\Gamma^{(k_i, r_i)}, x_{3, i})}\times \Pr (\{ \omega\colon  \varkappa_{3, i+1} = x_{3, i+1}\} |\cap_{t=0}^{i}\{\omega\colon  \Gamma_t=\Gamma^{(k_t, r_t)},  \varkappa_t=x^t\})
\end{multline*}
для $\Gamma^{(k_i, r_i)}\in \Gamma$,  $x_{3, i}\in {\mathbb Z}_+$,  $i\geqslant 0$. Учитывая равенство \eqref{kappa:3:conditional},  убеждаемся,  что вероятность 
$$
\Pr (\{\omega\colon  \Gamma_{i+1} =\Gamma^{(k_{i+1},  r_{i+1})},  \varkappa_{3,  i+1} = x_{3,  i+1}\} |\cap_{t=0}^{i}\{\omega\colon \Gamma_t=\Gamma^{(k_t,  r_t)},   \varkappa_t=x^t\}) 
$$ 
равна
$$
\delta_{\Gamma^{(k_{i+1},  r_{i+1})},  h(\Gamma^{(k_i,  r_i)},  x_{3,  i})} \times \widetilde{\varphi}_3(k_{i+1},  r_{i+1},  h_T(\Gamma^{(k_i,  r_i)},  x_{3,  i}),  x_{3,  i},  x_{3,  i+1})
$$
и зависит только от значений пар $(\Gamma_i,  \varkappa_{3,  i})$ и $(\Gamma_{i+1},  \varkappa_{3,  i+1})$. Следовательно,   
\begin{multline*}
\Pr (\{ \omega\colon \Gamma_{i+1} =\Gamma^{(k_{i+1},  r_{i+1})},  \varkappa_{3,  i+1} = x_{3,  i+1}\} |\cap_{t=0}^{i}\{\omega\colon \Gamma_t=\Gamma^{(k_t,  r_t)},   \varkappa_t=x^t\})=\\
=\Pr (\{\omega\colon   \Gamma_{i+1} =\Gamma^{(k_{i+1},  r_{i+1})},  \varkappa_{3,  i+1} = x_{3,  i+1}\} |\{\omega\colon  \Gamma_i=\Gamma^{(k_i,  r_i)},   \varkappa_{3,  i}=x_{3,  i}\}) = \\
=\Pr (\{\omega\colon \Gamma_{i+1} =\Gamma^{(k_{i+1},  r_{i+1})},  \varkappa_{3,  i+1} = x_{3,  i+1}\} |\cap_{t=0}^{i}\{ \omega\colon \Gamma_t=\Gamma^{(k_t,  r_t)},   \varkappa_{3,  t}=x_{3,  t}\}),  
\end{multline*}
что доказывает марковость последовательности $\MarkThree$.
\end{proof}

Убедившись в марковости последовательностей $\Mark$ и $\MarkThree$,   приведем формулы для вычисления их одношаговых переходных вероятностей. Для этого введем множество ${\mathbb A}_{\mathrm{trans}} = {\mathbb A}_{\mathrm{trans}}(x,  \tilde{x},  \tilde{k},  \tilde{r})$,   $x$,   $\tilde{x}\in \mathbb{Z}_+^4$ и $\Gamma^{(k,  r)}$,   $\Gamma^{(\tilde{k},  \tilde{r})}=h(\Gamma^{(k,  r)},  x_3) \in \Gamma$,    и определим его следующим образом:
\begin{align}
{\mathbb A}_{\mathrm{trans}}(x,  \tilde{x},  \tilde{k},  \tilde{r}) &= {\mathbb A}_{\mathrm{trans}}^0(x,  \tilde{x},  \tilde{k},  \tilde{r}) \cap {\mathbb A}_{\mathrm{trans}}^1(x,  \tilde{x},  \tilde{k},  \tilde{r})\cap {\mathbb A}_{\mathrm{trans}}^2(x,  \tilde{x},  \tilde{k},  \tilde{r}),  \label{A:trans:1}\\
{\mathbb A}_{\mathrm{trans}}^0(x,  \tilde{x},  \tilde{k},  \tilde{r}) &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(\tilde{k},  \tilde{r},  1),   x_1+a_1}\} +x_4-\tilde{x}_4\},  \\
{\mathbb A}_{\mathrm{trans}}^1(x,  \tilde{x},  \tilde{k},  \tilde{r}) &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon \tilde{x}_1=\max{\{0,  x_1+a_1-\ell(\tilde{k},  \tilde{r},  1)\}}\},  \\
{\mathbb A}_{\mathrm{trans}}^2(x,  \tilde{x},  \tilde{k},  \tilde{r}) &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  \tilde{x}_2=\max{\{0,  x_2+a_2-\ell(\tilde{k},  \tilde{r},  2)\}}\}.\label{A:trans:2}
\end{align}
Множества ${\mathbb A}_{\mathrm{trans}}^0(x,  \tilde{x},  \tilde{k},  \tilde{r})$,   ${\mathbb A}_{\mathrm{trans}}^1(x,  \tilde{x},  \tilde{k},  \tilde{r})$ и ${\mathbb A}_{\mathrm{trans}}^2(x,  \tilde{x},  \tilde{k},  \tilde{r})$ состоят из тех пар $(a_1,  a_2)$ количеств требований в очередях $O_1$ и $O_2$,   которые могут иметь место в нашей абстрактной управляющей системе Ляпунова--Яблонского в соответствии с уравнениями \eqref{gammaFunc},   \eqref{queuesFunc},   \eqref{FourthFunc},   \eqref{ProbablititiesToProve}. А именно,   содержательный смысл множества  ${\mathbb A}_{\mathrm{trans}}^0(x,  \tilde{x},  \tilde{k},  \tilde{r})$ состоит в том,   что оно учитывает количество требований в очереди $O_4$ на текущем и следующем тактах: $x_4$ и $\tilde{x}_4$,~--- а также учитывает знание количества требований,  находившихся и пришедших в очередь $O_1$. Множество ${\mathbb A}_{\mathrm{trans}}^1(x,  \tilde{x},  \tilde{k},  \tilde{r})$ учитывает изменение количества требований в очереди $O_1$: $x_1$ и $\tilde{x}_1$. И наконец,   множество 
${\mathbb A}_{\mathrm{trans}}^2(x,  \tilde{x},  \tilde{k},  \tilde{r})$ контролирует изменение количества требований $x_2$ и $\tilde{x}_2$ в очереди $O_2$ на последовательных тактах функционирования системы.
\begin{theorem}
Пусть $x$,   $\tilde{x}\in \mathbb{Z}_+^4$ и $\Gamma^{(k,  r)}$,   $\Gamma^{(\tilde{k},  \tilde{r})}=h(\Gamma^{(k,  r)},  x_3) \in \Gamma$. Тогда переходные вероятности однородной счетной марковской цепи $\Mark$ вычисляются по следующей формуле:
\begin{multline}
\Pr (\{\omega\colon \Gamma_{i+1}=\Gamma^{(\tilde{k},  \tilde{r})},  \varkappa_{i+1}=\tilde{x} \}| \{\omega\colon \Gamma_{i}=\Gamma^{(k,  r)},  \varkappa_i=x\})=\\ 
=\widetilde{\varphi}_3(\tilde{k},  \tilde{r},  h_T(\Gamma^{(k,  r)},  x_3),  x_3,  \tilde{x}_3)\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  h_T(\Gamma^{(k,  r)},  x_3))  \psi(a_2,  x_4,   p_{\tilde{k},  \tilde{r}}).
\label{transitionToProve}
\end{multline}
\end{theorem}
\begin{proof}
В случае если $\Gamma^{(\tilde{k},  \tilde{r})}=h(\Gamma^{(k,  r)},  x_3)$,   искомая вероятность упростится следующим образом:
\begin{equation*}
\Pr (A_{i+1}(\tilde{k},  \tilde{r},  \tilde{x})| A_{i}({k},  {r},  {x})) 
=\Pr (\{\omega\colon \varkappa_{i+1}=\tilde{x}\}|A_{i}({k},  {r},  {x})).
\end{equation*}
Здесь используются те же обозначения для множеств $A_{i}({k},  {r},  {x})$,   что и в выражении \eqref{new:notation:eta:xi:forget}.

По аналогии с выводом формул \eqref{kappa:2:conditional} и \eqref{kappa:3:conditional},   для доказательства воспользуемся формулой полной вероятности:
\begin{multline*}
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|A_i(k,  r,  x) )= \sum_{a,  b \in \mathbb{Z}_+^4} \Pr (\{\omega\colon\eta_i=a,   \xi_i=b\}|A_i(k,  r,  x)) \times \\ 
\times
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|A_i(k,  r,  x) \cap \{\omega\colon \eta_i=a; \xi_i=b\}).
\end{multline*}
Учтем формулы \eqref{ProbablititiesToProve} и \eqref{eta:xi:forgetProperty}:
\begin{multline*}
\Pr (\{\omega\colon \varkappa_{i+1}=\tilde{x}\}|\{\omega\colon\Gamma_{i}=\Gamma^{(k,  r)},  \varkappa_i=x\})
=\sum_{a,  b \in \mathbb{Z}_+^4} \varphi(a,  k,  r,  x) \zeta(b,  k,  r,  x)
\times \\ \times
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|\{\omega\colon\Gamma_{i}=\Gamma^{(k,  r)},  \varkappa_i=x,   \eta_i=a, \xi_i=b\}).
\end{multline*}
Из условий \eqref{queuesFunc} и \eqref{FourthFunc} следует
\begin{multline*}
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|\{\omega\colon\Gamma_{i}=\Gamma^{(k,  r)},  \varkappa_i=x\})=\sum_{a,  b \in \mathbb{Z}_+^4} \varphi(a,  k,  r,  x) \zeta(b,  k,  r,  x)
\times \\ \times \delta_{\tilde{x}_1,  \max{\{0,  x_1+a_1-b_1\}}} \times 
 \delta_{\tilde{x}_3,  \max{\{0,  x_3+a_3-b_3\}}} \times
\delta_{\tilde{x}_2,  \max{\{0,  x_2+a_2-b_2\}}} \times
\delta_{\tilde{x}_4,  x_4+a_4-a_2}
\end{multline*}
Раскроем  функции $\varphi(\cdot,   \cdot,   \cdot,   \cdot)$ и $\zeta(\cdot,  \cdot,  \cdot,  \cdot)$ и перегруппируем множители:
\begin{multline*}
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|\{\Gamma_{i}=\Gamma^{(k,  r)},  \varkappa_i=x\})= \\
=\sum_{a_1,  b_1 \in \mathbb{Z}_+} \varphi_1(a_1,  h_T(\Gamma^{(k,  r)},  x_3)) \delta_{b_1,  \ell(\tilde{k},  \tilde{r},  1)} \delta_{\tilde{x}_1,  \max{\{0,  x_1+a_1-b_1\}}} \times \\
\times \sum_{a_3,  b_3 \in \mathbb{Z}_+}  \varphi_3(a_3,  h_T(\Gamma^{(k,  r)},  x_3)) \delta_{b_3,  \ell(\tilde{k},  \tilde{r},  3)}  \delta_{\tilde{x}_3,  \max{\{0,  x_3+a_3-b_3\}}} \times \\
\times \sum_{a_2,  b_2 \in \mathbb{Z}_+}  \psi(a_2,  x_4,   p_{\tilde{k},  \tilde{r}})   \delta_{b_2,  \ell(\tilde{k},  \tilde{r},  2)}   \delta_{\tilde{x}_2,  \max{\{0,  x_2+a_2-b_2\}}} \times \\
\times \sum_{a_4,  b_4 \in \mathbb{Z}_+}  \delta_{a_4,  \min{\{\ell(\tilde{k},  \tilde{r},  1),   x_1+a_1}\}}   \delta_{b_4,  x_4} \delta_{\tilde{x}_4,  x_4+a_4-a_2}.
\end{multline*}
Поскольку произведение $\delta_{\tilde{x}_4,  x_4+a_4-a_2}\times \delta_{a_4,  \min{\{\ell(\tilde{k},  \tilde{r},  1),   x_1+a_1}\}}$ отлично от нуля,   если и только если $a_2 = \min{\{\ell(\tilde{k},  \tilde{r},  1),   x_1+a_1}\} +x_4-\tilde{x}_4$,   то
\begin{multline*}
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|\{\omega\colon\Gamma_{i}=\Gamma^{(k,  r)},  \varkappa_i=x\})=\\=\sum_{a_3\in \mathbb{Z}_+}  \varphi_3(a_3,  h_T(\Gamma^{(k,  r)},  x_3))  \delta_{\tilde{x}_3,  \max{\{0,  x_3+a_3-\ell(\tilde{k},  \tilde{r},  3)\}}} 
\times\sum_{a_1 \in \mathbb{Z}_+} \varphi_1(a_1,  h_T(\Gamma^{(k,  r)},  x_3))  \times \\ \times \psi(a_2,  x_4,   p_{\tilde{k},  \tilde{r}}) 
\times \delta_{\tilde{x}_1,  \max{\{0,  x_1+a_1-\ell(\tilde{k},  \tilde{r},  1)\}}}  \delta_{\tilde{x}_2,  \max{\{0,  x_2+a_2-\ell(\tilde{k}, \tilde{r}, 2)\}}}.
\end{multline*}
Из определений \eqref{tildephi} видно,  что
\begin{equation*}
\sum_{a_3\in \mathbb{Z}_+}  \varphi_3(a_3, h_T(\Gamma^{(k, r)}, x_3))  \delta_{\tilde{x}_3, \max{\{0, x_3+a_3-\ell(\tilde{k}, \tilde{r}, 3)\}}} = \tilde{\varphi}_3(\tilde{k}, \tilde{r}, h_T(\Gamma^{(k, r)}, x_3), \tilde{x}_3), 
\end{equation*}
значит, 
\begin{multline*}
\Pr (\{\omega\colon\varkappa_{i+1}=\tilde{x}\}|\{\omega\colon\Gamma_{i}=\Gamma^{(k, r)}, \varkappa_i=x\})
=\tilde{\varphi}_3(\tilde{k}, \tilde{r}, h_T(\Gamma^{(k, r)}, x_3), \tilde{x}_3) \times\\
\times \sum_{a_1 \in \mathbb{Z}_+} \varphi_1(a_1, h_T(\Gamma^{(k, r)}, x_3))  \psi(a_2, x_4,  p_{\tilde{k}, \tilde{r}}) \times \\ \times \delta_{\tilde{x}_1, \max{\{0, x_1+a_1-\ell(\tilde{k}, \tilde{r}, 1)\}}}  \delta_{\tilde{x}_2, \max{\{0, x_2+a_2-\ell(\tilde{k}, \tilde{r}, 2)\}}}.
\end{multline*}
что есть в точности \eqref{transitionToProve}.
\end{proof}
Таким образом,  в нашем арсенале теперь есть вид переходных вероятностей цепи $\Mark$ и,  следовательно,  можем постараться найти множество ее существенных состояний. Сформулируем аналогичный результат для цепи $\MarkThree$.
\begin{theorem}
Пусть $x_3$,  $\tilde{x}_3\in \mathbb{Z}_+$ и $\Gamma^{(k, r)}\in \Gamma$,  $\Gamma^{(\tilde{k}, \tilde{r})}=h(\Gamma^{(k, r)}, x_3) \in \Gamma$. Тогда переходные вероятности однородной счетной марковской цепи $$
\MarkThree
$$
вычисляются по следующей формуле:
\begin{multline}
\Pr (\{\omega\colon\Gamma_{i+1}=\Gamma^{(\tilde{k}, \tilde{r})}, \varkappa_{3, i+1}=\tilde{x}\}|\{\omega\colon\Gamma_{i}=\Gamma^{(k, r)}, \varkappa_{3, i}=x\}) 
= \\ =\widetilde{\varphi}_3(\tilde{k}, \tilde{r}, h_T(\Gamma^{(k, r)}, x_3), x_3, \tilde{x}_3).
\label{transitionToProve:three}
\end{multline}
\end{theorem}
\begin{proof}
Доказательство следует из равенства \eqref{kappa:3:conditional}.
\end{proof}


\section[Классификация состояний управляющей системы Ляпунова--Яблонского как марковской цепи]%
{Классификация состояний управляющей системы Ляпунова--Яблонского  как марковской цепи}
% \section[Классификация состояний по арифметическим свойствам переходных вероятностей марковской цепи ${\Mark}$]%
% {Классификация состояний по арифметическим \\ свойствам переходных вероятностей марковской цепи\\ $\boldsymbol{\Mark}$}
Теперь найдем множество существенных состояний марковской цепи $\Mark$,  которая описывает динамику исследуемой в работе управляющей системы. Мы последовательно рассмотрим состояния разного вида и определим сообщающиеся подклассы. 
% Для этого введем множество 
% \begin{equation*}
% {\mathbb X}^{(k, r)} = \{x = (x_1, x_2, x_3, x_4) \in \mathbb{Z}_+^4 \colon (x_1 > 0) \Rightarrow (x_4 \geqslant \ell(k, r, 1))\}, 
% \end{equation*}
% где $k$ и $r$ такие,  что $\Gamma^{(k, r)}\in \Gamma$. Содержательный смысл множества ${\mathbb X}^{(k, r)}$ в описании одного из необходимых свойств,  которым должны обладать все существенные состояния: если количество требований в очереди $O_1$ в начале очередного такта больше нуля,  то на предыдущем такте обслужилось не меньше $\ell(k, r, 1)$ требований очереди $O_1$ и,  следовательно,  в очередь $O_4$ поступить требований меньше $\ell(k, r, 1)$ также не могло.

На первом этапе докажем,  что состояния вида 
$$(\Gamma^{(0,  \tilde{r})},  \tilde{x}),  \quad \tilde{r} = \overline{1,  n_0},  \tilde{x}=(0,  0,  L+1,  0), $$ 
являются существенными (леммы \ref{classification:arithm:1},  \ref{classification:arithm:2},  \ref{first:lemma}). Лемма~\ref{classification:arithm:1},  в частности,  говорит о том,  что из состояний продления с произвольным количеством требований в очередях $O_1$,  $O_2$ и $O_4$ можно перейти с ненулевой вероятностью также в состояние продления,  но с пустыми очередями $O_1$,  $O_2$ и $O_4$.

\begin{lemma}
Состояния вида 
$$(\Gamma^{(0,  \tilde{r})}, (0,  0,  \tilde{x}_3,  0)),  \quad \tilde{r} = \overline{1,  n_0},  \tilde{x}_3 \geqslant x_{3,  0}, $$
достижимы из состояний вида 
$$(\Gamma^{(0,  r_0)},  x^0),  \quad r_0=\overline{1,  n_0},  x^0 \hm\in \mathbb{Z}_+^4,  x^0\hm=(x_{1, 0},  x_{2, 0},  x_{3, 0},  x_{4, 0}),  x_{3,  0} \leqslant L.$$
\label{classification:arithm:1}
\end{lemma}
\begin{proof}
Для доказательства достаточно показать,  что существует такое натуральное число $N$,  что 
\begin{equation*}
\Pr(\{\omega\colon\Gamma_{N}=\Gamma^{(0, \tilde{r} )},  \varkappa_{N}=(0,  0,  \tilde{x}_3,  0)\}|
\{\omega\colon\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0} = x^0\})>0.
\end{equation*}
Докажем сначала,  что вероятность каждого шага в цепочке
\begin{equation*}
(\Gamma^{(0, r_0)}, x^0) \rightarrow (\Gamma^{(0, r_0\oplus_{0}1)}, x^1) \rightarrow (\Gamma^{(0, r_0\oplus_{0}2)},  x^2) \rightarrow \ldots \rightarrow (\Gamma^{(0,  r_0\oplus_{0} N_2)},  x^{N_2})
\end{equation*}
для любого $N_2 > 0$ положительна. Вектора $x^j$,  $j>1$,  определим ниже.

Пусть система стартовала в состоянии $(\Gamma_{0},  \varkappa_{0}) = (\Gamma^{(0, r_0)},  x^0)$.
Из формул \eqref{hLaw} и \eqref{gammaFunc} следует,  что 
\begin{equation*}
\Gamma_1 = h(\Gamma_0, \varkappa_{3, 0}) = h(\Gamma^{(0, r_0)},  x_{3, 0}) = \Gamma^{(0, r_0\oplus_{0}1)}.
\end{equation*}
Положим
\begin{multline*}
x^1 =(x_{1, 1}, x_{2, 1}, x_{3, 1}, x_{4, 1}) =\left(\max{\{0,  x_{1, 0} - \ell(0, r_0\oplus_{0}1, 1)\}}; \right. \\
\left. \max{\{0,  x_{2, 0} + x_{4, 0}  - \ell(0, r_0\oplus_{0}1, 2)\}}; x_{3, 0};\min{\{x_{1, 0}, \ell(0, r_0\oplus_{0}1, 1)\}}\right).
\end{multline*}
Тогда,  учитывая формулу \eqref{transitionToProve},  имеем
\begin{multline}
\Pr (\{\omega\colon\Gamma_{1}=\Gamma^{(0,  r_0 \oplus_{0} 1)},  \varkappa_{1}=x^1 \}|\{\omega\colon \Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_0 = x^0)=\\=\widetilde{\varphi}_3(0,  r_0\oplus_{0}1,  T^{(0,  r_0\oplus_{0}1)},  x_{3, 0},  x_{3, 0}\})
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_0\oplus_{0}1)})  \psi(a_2,  x_{4,  0},  p_{0,  r_0\oplus_{0}1}), 
\label{important:1}
\end{multline}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  x_{4, 0})$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}} = {\mathbb A}_{\mathrm{trans}}(x^0,  x^1,  0,  r_0\oplus_{0}1) = {\mathbb A}_{\mathrm{trans}}^0 \cap {\mathbb A}_{\mathrm{trans}}^1\cap {\mathbb A}_{\mathrm{trans}}^2, \displaybreak[0]\\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(0,  r_0\oplus_{0}1,  1),  x_{1, 0}+a_1}\} +x_{4, 0}-x_{4, 1}\}, \displaybreak[0]\\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_{1,  1}=\max{\{0, x_{1,  0}+a_1-\ell(0,  r_0\oplus_{0} 1,  1)\}}\}, \displaybreak[0]\\
 &{\mathbb A}_{\mathrm{trans}}^2= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  x_{2,  1}=\max{\{0,  x_{2, 0}+a_2-\ell(0,  r_0\oplus_{0}1, 2)\}}\}.
\end{align*}
Действительно,  при  $x_{4,  1}=\min{\{x_{1,  0},  \ell(0,  r_0\oplus_{0}1,  1)\}}$ и $a_1 = 0$ условие для $a_2$ во множестве ${\mathbb A}_{\mathrm{trans}}^0$ примет вид:
\begin{multline*}
a_2=\min{\{\ell(0,  r_0\oplus_{0}1,  1),  x_{1,  0} + a_1}\} +x_{4,  0}-\min{\{x_{1,  0},  \ell(0,  r_0\oplus_{0}1,  1)\}}  = \\ =
x_{4,  0} + \min{\{\ell(0,  r_0\oplus_{0}1,  1),  x_{1,  0} + a_1}\} -\min{\{x_{1,  0},  \ell(0,  r_0\oplus_{0}1,  1)\}}  = x_{4,  0}.
\end{multline*}
При $x_{1,  1} = \max{\{0,  x_{1,  0} - \ell(0,  r_0\oplus_{0}1,  1)\}}$,  $a_1 = 0$ условие для $a_2$ во множестве ${\mathbb A}_{\mathrm{trans}}^1$ примет вид:
\begin{equation*}
\max{\{0,  x_{1, 0} - \ell(0,  r_0\oplus_{0}1,  1)\}}  =\max{\{0,  x_{1, 0}+a_1-\ell(0,  r_0\oplus_{0}1,  1)\}}.
\end{equation*}
И при $x_{2,  1} = \max{\{0,  x_{2,  0} + x_{4,  0}  - \ell(0,  r_0\oplus_{0}1,  2)\}}$ условие для $a_2$ во множестве ${\mathbb A}_{\mathrm{trans}}^2$ примет вид:
\begin{equation*}
    \max{\{0,  x_{2,  0} + x_{4,  0}  - \ell(0,  r_0\oplus_{0}1,  2)\}} 
=\max{\{0,  x_{2,  0}+a_2-\ell(0,  r_0\oplus_{0}1,  2)\}}.
\end{equation*}
Следовательно,  множество ${\mathbb A}_{\mathrm{trans}}(x^0,  x^1,  0,  r_0\oplus_{0}1) $ не пусто.
Из определения \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0,  r_0\oplus_{0}1,  T^{(0,  r_0\oplus_{0}1)},  x_{3,  0},  x_{3,  0}) = \\ =
 (1-\delta_{x_{3,  1},  0}) \varphi_3(x_{3,  0} + \ell(0,  r_0\oplus_{0}1,  3) - x_{3,  0},  T^{(0,  r_0\oplus_{0}1)} )
+\\
+\delta_{x_{3,  1},  0} \sum_{a=0}^{ \ell(0,  r_0\oplus_{0}1,  3) - x_{3,  0} } \varphi_3 (a, T^{(0,  r_0\oplus_{0}1)})
\geqslant\\ \geqslant (1-\delta_{x_{3,  1},  0}) \varphi_3(x_{3,  0} + \ell (0,  r_0\oplus_{0}1,  3) - x_{3,  0}, T^{(0,  r_0\oplus_{0}1)} ) + \\
+\delta_{x_{3,  1},  0} \varphi_3 (0,  T^{(0,  r_0\oplus_{0}1)}) > 0.
\end{multline*}
Поскольку $1>p_{0,  r_0\oplus_{0}1} > 0$,  то 
$$\psi(x_{4, 0},  x_{4, 0},  p_{0,  r_0\oplus_{0}1}) = C_{x_{4,  0}}^{x_{4,  0}} p_{0,  r_0\oplus_{0}1}^{x_{4,  0}} > 0,  \quad \varphi_1(0,  T^{(0,  r_0\oplus_{0}1)}) > 0.$$ Следовательно,  выражение $\eqref{important:1}$ преобразуется следующим образом:
\begin{multline*}
\Pr (\{\omega\colon\Gamma_{1}=\Gamma^{(0,  r_0\oplus_{0}1)}, \varkappa_{1}=x^1 \}|\{\omega\colon \Gamma_{0}=\Gamma^{(0,  r_0)}, \varkappa_0=x^0\})\geqslant \\
\geqslant \widetilde{\varphi}_3(0,  r_0\oplus_{0}1,  T^{(0,  r_0\oplus_{0}1)},  x_{3,  0},  x_{3,  0})
\times
\varphi_1(0,  T^{(0,  r_0\oplus_{0}1)}) \psi(x_{4,  0}, x_{4,  0},  p_{0,   r_0\oplus_{0}1}) > 0.
\end{multline*}
Таким образом, вероятность за один такт перейти из состояния $(\Gamma^{(0,  r_0)},  x^0)$ в состояние $ (\Gamma^{(0,  r_0\oplus_{0}1)},  x^1)$ положительна.

Поскольку никаких ограничений на вектор $x^0 \in \mathbb{Z}_+^4$,  кроме $x_{3,  0}\leqslant L$,  наложено не было,  то аналогичными рассуждениями (положив $x^0=x^1$ и $x^1=x^2$) можем получить
\begin{equation*}
\Pr (\{\omega\colon\Gamma_{2}=\Gamma^{(0,  r_0\oplus_{0}2)}, \varkappa_{2}=x^2 \} |\{\omega\colon \Gamma_{1}=\Gamma^{(0,  r_0\oplus_{0}1)}, \varkappa_1=x^1\}) > 0, 
\end{equation*}
для 
\begin{multline*}
x^2  =\left(\max{\{0,  x_{1,  1} - \ell(0,  r_0\oplus_{0}2,  1)\}}; \right. \\
\left. \max{\{0,  x_{2,  1} + x_{4,  1}  - \ell(0,  r_0\oplus_{0}2,  2)\}}; x_{3,  0};\min{\{x_{1,  1}, \ell(0,  r_0\oplus_{0}2,  1)\}}\right).
\end{multline*}
В общем случае
\begin{equation*}
\Pr (\{\omega\colon\Gamma_{j+1}=\Gamma^{(0,  r_0\oplus_{0}j+1)}, \varkappa_{j+1}=x^{j+1} \} |\{\omega\colon \Gamma_{j}=\Gamma^{(0,  r_0\oplus_{0}j)},  \varkappa_j=x^j\}) > 0, 
\end{equation*}
для 
\begin{multline*}
x^{j+1}  =\left(\max{\{0,  x_{1,  j} - \ell(0,  r_0\oplus_{0}j+1,  1)\}}; \right. \\
\left. \max{\{0,  x_{2, j} + x_{4, j}  - \ell(0,  r_0\oplus_{0}j+1,  2)\}}; x_{3,  0};\min{\{x_{1,  j},  \ell(0,  r_0\oplus_{0}j+1,  1)\}}\right), 
\end{multline*}
для $j = 1$,  $2$,  $\ldots$,  $N_2$. Число $N_2$ будет определено ниже.

Так как для каждой очереди $O_s$,  $s=1, 2, 4$,  найдется состояние продления,  в котором она обслуживается (состояния продления образуют цикл),  т.~е. $\ell(0,  r_0\oplus_{0}j,  s)>0$,  то для некоторого $N_1>0$ количество требований $x_{1,  N_1}$,  $x_{2,  N_1}$ и $x_{4,  N_1}$ в соответствующих очередях $O_1$,  $O_2$ и $O_4$ станет равным нулю,  т.е. 
\begin{multline*}
\Pr (\{\omega\colon\Gamma_{N_1}=\Gamma^{(0,  r_0\oplus_{0}N_1)}, \varkappa_{N_1}=x^{N_1} \}|\\ \{\omega\colon\Gamma_{N_1-1}=\Gamma^{(0,  r_0\oplus_{0}(N_1-1))},  \varkappa_{N_1-1}=x^{N_1-1}\}) > 0, 
\end{multline*}
для $x^{N_1} = \left(0; 0; x_{3,  0};0\right)$. Поскольку все состояния продления образуют цикл,  то существует такое число $N_2>N_1$,  что $r_0 \oplus_0  N_2 = \tilde{r} \ominus_0 1$ и 
\begin{multline*}
\Pr (\{\omega\colon\Gamma_{N_2}=\Gamma^{(0,  r_0\oplus_{0} N_2)}, \varkappa_{N_2}=x^{N_2} \}|\\ \{\omega\colon\Gamma_{N_2-1}=\Gamma^{(0,  r_0\oplus_{0}(N_2-1))}, \varkappa_{N_2-1}=x^{N_2-1}\}) > 0, 
\end{multline*}
где $x^{N_2} = (0, 0, x_{3, 0}, 0)$.
Для завершения доказательства теперь необходимо рассмотреть переход
\begin{equation*}
 (\Gamma^{(0,  r_0\oplus_{0} N_2)},  x^{N_2})  \rightarrow (\Gamma^{(0,  \tilde{r})},  x^{N_2+1}), 
\end{equation*}
то есть оценить вероятность перехода
\begin{equation*}
\Pr (\{\omega\colon\Gamma_{N_2+1}=\Gamma^{(0,  \tilde{r})},  \varkappa_{N_2+1}= x^{N_2+1} \}| \{\omega\colon\Gamma_{N_2}=\Gamma^{(0,  r_0\oplus_{0}N_2)},  \varkappa_{N_2}=x^{N_2}\}), 
\end{equation*}
где 
$$(\Gamma_{N_2+1},  \varkappa_{N_2+1})= (\Gamma^{(0,  r_0\oplus_{0} N_2))},  x^{N_2+1}) = (\Gamma^{(0,  \tilde{r})} ,  (0,  0,  \tilde{x}_3,  0) )$$
есть конечное состояние.
Опять учитывая формулу \eqref{transitionToProve},  имеем
\begin{multline*}
\Pr (\{\omega\colon\Gamma_{N_2+1}=\Gamma^{(0,  \tilde{r})}, \varkappa_{N_2+1}=x^{N_2+1} \}| \{\omega\colon\Gamma_{N_2}=\Gamma^{(0,  r_0\oplus_{0}N_2)}, \varkappa_{N_2}=x^{N_2}\})=\\
=\widetilde{\varphi}_3(0,  \tilde{r},  T^{(0,  \tilde{r})},  x_{3,  0}, \tilde{x}_3)
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  \tilde{r})})  \psi(a_2,  0,  p_{0,  \tilde{r}}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}} = {\mathbb A}_{\mathrm{trans}}(x^{N_2},  x^{N_2+1},  0,  \tilde{r}) = {\mathbb A}_{\mathrm{trans}}^0 \cap {\mathbb A}_{\mathrm{trans}}^1\cap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(0,  \tilde{r},  1),  a_1}\} \}, \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon 0=\max{\{0,  a_1-\ell(0,  \tilde{r}, 1)\}}\}, \\
 &{\mathbb A}_{\mathrm{trans}}^2= \{(a_1, a_2) \in \mathbb{Z}_+^2 \colon  0=\max{\{0,  a_2-\ell(0,  \tilde{r},  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{equation*}
\widetilde{\varphi}_3(0,  \tilde{r},  T^{(0,  \tilde{r})},  x_{3,  0},  \tilde{x}_3)\geqslant (1-\delta_{\tilde{x}_3,  0}) \varphi_3(\tilde{x}_3 + 0 - x_{3,  0},  T^{(0,  \tilde{r})} ) + \delta_{\tilde{x}_3,  0} \varphi_3(0,  T^{(0,  \tilde{r})}) > 0.
\end{equation*}
Следовательно,  
\begin{multline*}
\Pr (\{\omega\colon\Gamma_{N_2+1}=\Gamma^{(0,  \tilde{r})}, \varkappa_{N_2+1}=x^{N_2+1} \}| \{\omega\colon\Gamma_{N_2}=\Gamma^{(0,  r_0\oplus_{0}N_2)}, \varkappa_{N_2}=x^{N_2}\})\geqslant\\
\geqslant \widetilde{\varphi}_3(0,  \tilde{r},  T^{(0,  \tilde{r})},  x_{3,  0},  \tilde{x}_3)
\times
\varphi_1(0,  T^{(0,  \tilde{r})}) \psi(0,  0,  p_{0,  \tilde{r}}) > 0.
\end{multline*}

Положим $N = N_2+1$ и соберем все воедино:
\begin{multline*}
\Pr(\{\omega\colon\Gamma_{N}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{N}=x^N\}| \{\omega\colon
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\}) = \\ =
\Pr(\{\omega\colon\Gamma_{N_2+1}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{ N_2+1}=x^{N_2+1}\}|\{\omega\colon
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\}) \geqslant \\ 
\geqslant
\Pr(C|\{\omega\colon\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\}), 
\end{multline*}
где 
\begin{multline*}
    C =\\= \left\{\omega\colon\Gamma_{ N_2+1}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{ N_2+1}=x^{N_2+1}\right\} \cap \left\{ \omega\colon \Gamma_{ N_2}=\Gamma^{(0,  \tilde{r} \ominus_0 1 )},  \varkappa_{N_2}=x^{N_2}\right\} \cap\ldots \Bigr.\\ \Bigl.
\ldots \cap \left\{\omega\colon\Gamma_{2}=\Gamma^{(0,  r_0\oplus_{0}2)}, \varkappa_{2}=x^2\right\} \cap \left\{\omega\colon \Gamma_{1}=\Gamma^{(0,  r_0\oplus_{0}1)}, \varkappa_{1}=x^1\right\}.
\end{multline*}
Наконец,  из теоремы умножения и марковского свойства заключаем,  что 
\begin{multline*}
\Pr\Bigl(\Bigl\{\omega\colon \Gamma_{N}=\Gamma^{(0, \tilde{r} )},  \varkappa_{N}=x^N\Bigr\} \,  \Big|\Bigl\{\omega\colon 
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\Bigr\}\Bigr) \geqslant \\ 
\geqslant
\Pr\Bigl(\Bigl\{\omega\colon \Gamma_{N_2+1}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{ N_2+1}=x^{N_2+1}\Bigr\}\,  \Big| \Bigl\{\omega\colon \Gamma_{ N_2}=\Gamma^{(0,  \tilde{r} \ominus_0 1 )},  \varkappa_{N_2}=x^{N_2}\Bigr\}\Bigr) \times 
%
\\ \times
\Pr\Bigl(\!\Bigl\{\omega\colon\Gamma_{ N_2}=\Gamma^{(0,  \tilde{r} \ominus_0 1 )},  \varkappa_{N_2}=x^{N_2}\Bigr\} \, \Big| \Bigl\{\omega\colon \Gamma_{ N_2-1}=\Gamma^{(0, \tilde{r} \ominus_0 2 )},  \varkappa_{N_2-1}=x^{N_2-1}\Bigr\}\Bigr) \times 
%
\\ \times \ldots
\times 
\Pr\Bigl(\Bigl\{\omega\colon\Gamma_{2}=\Gamma^{(0,  r_0\oplus_{0}2)}, \varkappa_{2}=x^2\Bigr\}\,  \Big|  \Bigl\{\omega\colon \Gamma_{1}=\Gamma^{(0,  r_0\oplus_{0}1)},  \varkappa_{1}=x^1\Bigr\}\Bigr) \times 
\\
\times
\Pr\Bigl(\Bigl\{\omega\colon\Gamma_{1}=\Gamma^{(0,  r_0\oplus_{0}1)},  \varkappa_{1}=x^1\Bigr\} \, \Big| \Bigl\{\omega\colon \Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\Bigr\}\Bigr)>0, 
\end{multline*}
что и требовалось доказать. Таким образом,  каждый переход в цепочке переходов
\begin{multline*}
(\Gamma^{(0, r_0)}, x^0) \rightarrow (\Gamma^{(0, r_0\oplus_{0}1)}, x^1) \rightarrow (\Gamma^{(0, r_0\oplus_{0}2)},  x^2) \rightarrow \ldots \\ \ldots \rightarrow (\Gamma^{(0,  r_0\oplus_{0} N_2)},  x^{N_2})   \rightarrow (\Gamma^{(0,  \tilde{r})},  x^{N_2+1})
\end{multline*}
от начального до конечного состояний имеет ненулевую вероятность.
\end{proof}

В лемме~\ref{classification:arithm:2} покажем,  как из произвольного состояния цикла $k_0 > 0$ перейти в состояние продления с заданным количеством требований $0$,  $0$,  $L+1$,  $0$  в очередях $O_1$,  $O_2$,  $O_3$,  $O_4$ соответственно.
\begin{lemma}
Состояния вида 
$$(\Gamma^{(0,  \tilde{r})},  \tilde{x}),  \quad \tilde{r} = \overline{1,  n_0},  \tilde{x}=(0,  0,  L+1,  0), $$
 достижимы из состояний вида 
 \begin{equation*}
 (\Gamma^{(k_0,  r_0)},  x^0),  \quad k_0 > 0,  r_0=\overline{1,  n_{k_0}},  x^0 \in \mathbb{Z}_+^4.
 \end{equation*}
\label{classification:arithm:2}
\end{lemma}
\begin{proof}
Для доказательства достаточно показать,  что существует такое натуральное число $N$,  что 
\begin{equation*}
\Pr(\{\omega\colon \Gamma_{N}=\Gamma^{(0, \tilde{r} )},  \varkappa_{N}=\tilde{x}\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(k_0,  r_0)},  \varkappa_{0}=x^0\})>0.
\end{equation*}

Как и в предыдущей лемме рассмотрим сначала последовательность состояний в рамках одного цикла с индексом  $k_0$: 
\begin{equation*}
(\Gamma^{(k_0,  r_0)},  x^0) \rightarrow (\Gamma^{(k_0,  r_0\oplus_{k_0}1)},  x^1) \rightarrow (\Gamma^{(k_0,  r_0\oplus_{k_0}2)},  x^2) \rightarrow \ldots \rightarrow (\Gamma^{(k_0,  r_0\oplus_{k_0}N_1)},  x^{N_1}), 
\end{equation*}
где $x^0=(x_{1, 0},  x_{2, 0},  x_{3, 0},  x_{4, 0})$ и число $N_1 \geqslant 0$ определено ниже. Пусть 
\begin{multline*}
x^{j+1}=\\
=\Bigl(\max{\Bigl\{0,  x_{1, j} - \ell(k_0,  r_0\oplus_{k_0} j+1,  1)\Bigr\}};
\max{\Bigl\{0,  x_{2, j} - \ell(k_0,  r_0\oplus_{k_0} j+1, 2)\Bigr\}};\Bigr.\\
\Bigl.\max{\Bigl\{0,  x_{3, j} - \ell(k_0,  r_0\oplus_{k_0} j+1,  3)\Bigr\}};
x_{4,  j} + \min{\Bigl\{x_{1,  j},  \ell(k_0,  r_0\oplus_{k_0} j+1,  1)\Bigr\}}\Bigr), 
\end{multline*}
$j=\overline{0,  N_1-1}$. Пусть далее $N_1$~--- это первый номер,  при котором одновременно выполнено два условия: 1) обслуживающее устройство находится в выходном состоянии,  то есть $r_0\oplus_{k_0}N_1 = n_{k_0}$,  и 2) количество требований в очереди $O_3$ не превышает порог $L$,  то есть  $x_{3,  N_1}\leqslant L$. Такое $N_1$ всегда существует,  так как пока $x_{3,  j}>L$ и $r_0\oplus_{k_0}s \neq n_0$,  обслуживающее устройство будет находиться в цикле $k_0$ и периодически обслуживать третью очередь. То есть $\ell(k_0,  r_0\oplus_{k_0}s,  1)>0$  для некоторого $s \in \{1,  2,  \ldots,  n_{k_0}\}$. Для доказательства существования $N_1$ также важно учесть,  что в рассматриваемых нами графах переходов в каждом цикле $k_0>0$ существует выходное состояние и притом только одно. Заметим,  что в случае $x_{3,  0} \leqslant L$ и $r_0 = n_{k_0}$ можно положить $N_1 = 0$,  поэтому далее будем предполагать это условие не выполненным.

Учитывая формулу \eqref{transitionToProve} имеем
\begin{multline*}
\Pr (\{\omega\colon \Gamma_{1}=\Gamma^{(k_0,  r_0\oplus_{k_0}1)}, \varkappa_{1}=x^1 \}|\{\omega\colon  \Gamma_{0}=\Gamma^{(k_0,  r_0)},  \varkappa_0=x^0\})=\\
=\widetilde{\varphi}_3(k_0,  r_0\oplus_{k_0}1,  T^{(k_0,  r_0\oplus_{k_0}1)}, x_{3,  0}, \max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}})\times \\
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(k_0,  r_0\oplus_{k_0}1)})  \psi(a_2,  x_{4, 0},  p_{k_0,  r_0\oplus_{k_0}1}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0, 0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{equation*}
{\mathbb A}_{\mathrm{trans}}(x^0,  x^1,  k_0,  r_0\oplus_{k_0}1) = {\mathbb A}_{\mathrm{trans}}^0 \cap {\mathbb A}_{\mathrm{trans}}^1\cap {\mathbb A}_{\mathrm{trans}}^2, 
\end{equation*}
и
\begin{align*}
{\mathbb A}_{\mathrm{trans}}^0 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(k_0,  r_0\oplus_{k_0}1,  1),  x_{1,  0}+a_1}\} +x_{4, 0}- \\ 
&-x_{4,  0} - \min{\{x_{1,  0},  \ell(k_0,  r_0\oplus_{k_0}1,  1)\}}\}, \\
{\mathbb A}_{\mathrm{trans}}^1 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon \max{\{0,  x_{1, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  1)\}}=\\
&=\max{\{0,  x_{1, 0}+a_1-\ell(k_0,  r_0\oplus_{k_0}1,  1)\}}\}, \\
 {\mathbb A}_{\mathrm{trans}}^2 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  \max{\{0,  x_{2, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  2)\}}=\\
 &=\max{\{0,  x_{2, 0}+a_2-\ell(k_0,  r_0\oplus_{k_0}1,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(k_0,  r_0\oplus_{k_0}1,  T^{(k_0, r_0\oplus_{k_0}1)},  x_{3, 0},  \max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}})= \\=(1-\delta_{\max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}}, 0}) \times \\\times\varphi_3(\max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}} + \ell (k_0,  r_0\oplus_{k_0}1,  3) - x_{3,  0},  T^{(k_0,  r_0\oplus_{k_0}1)} ) +\\
+\delta_{\max{\{0,  x_{3,  0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}}, 0} \sum_{a=0}^{\ell(k_0,  r_0\oplus_{k_0}1,  3)-x_{3,  0}}\varphi_3 (a, T^{(k_0,  r_0\oplus_{k_0}1)}), 
\end{multline*}
а после приведения подобных слагаемых,  получим
\begin{multline*}
\widetilde{\varphi}_3(k_0,  r_0\oplus_{k_0}1,  T^{(k_0,  r_0\oplus_{k_0}1)},  x_{3, 0},  \max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}})=\\=(1-\delta_{\max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}}, 0}) \times \varphi_3(0,  T^{(k_0,  r_0\oplus_{k_0}1)} ) +\\
+\delta_{\max{\{0,  x_{3, 0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}}, 0} \sum_{a=0}^{\ell(k_0,  r_0\oplus_{k_0}1,  3)-x_{3,  0}}\varphi_3 (a, T^{(k_0,  r_0\oplus_{k_0}1)}) \geqslant \\ 
\geqslant (1-\delta_{\max{\{0,  x_{3,  0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}}, 0}) \times \varphi_3(0,  T^{(k_0,  r_0\oplus_{k_0}1)} ) + \\
+\delta_{\max{\{0,  x_{3,  0} - \ell(k_0,  r_0\oplus_{k_0}1,  3)\}}, 0} \varphi_3 (0,  T^{(k_0,  r_0\oplus_{k_0}1)}) = \varphi_3 (0,  T^{(k_0,  r_0\oplus_{k_0}1)})
>0.
\end{multline*}
Поскольку $1 > p_{k_0, r_0\oplus_{k_0}1} > 0$,  то 
$$\psi(0, x_{4, 0},  p_{k_0, r_0\oplus_{k_0}1}) = C_{x_{4, 0}}^{0} (1-p_{k_0, r_0\oplus_{k_0}1})^{x_{4, 0}} > 0,  \quad \varphi_1(0, T^{(k_0, r_0\oplus_{k_0}1)}) > 0.$$
Значит, 
\begin{multline*}
\Pr (\{\omega\colon \Gamma_{1}=\Gamma^{(k_0,  r_0\oplus_{k_0}1)}, \varkappa_{1}=x^1\} | \{\omega\colon \Gamma_{0}=\Gamma^{(k_0,  r_0)},  \varkappa_0=x^0\})\geqslant \\
\geqslant \widetilde{\varphi}_3(k_0,  r_0\oplus_{k_0}1,  T^{(k_0, r_0\oplus_{k_0}1)},  x_{3, 0},  x_{3, 1})
\varphi_1(0, T^{(k_0,  r_0\oplus_{k_0}1)})  \psi(0,  x_{4, 0},  p_{k_0,  r_0\oplus_{k_0}1}) > 0.
\end{multline*}
Таким образом,  вероятность за один такт перейти из состояния $(\Gamma^{(k_0,  r_0)},  x^0)$ в состояние $ (\Gamma^{(k_0,  r_0\oplus_{k_0}1)},  x^1)$ положительна.

Аналогичные рассуждения верны и для произвольного $j=\overline{1,  N_1-1}$
при переходе из состояния $(\Gamma^{(k_0,  r_0\oplus_{k_0} j)},  x^j)$ в состояние $(\Gamma^{(k_0,  r_0\oplus_{k_0}(j+1))},  x^j)$,  поскольку в качестве $x^0$ был взят произвольный вектор из $\mathbb{Z}_+^4$,  а в качестве $\Gamma^{(k_0,  r_0)}$ --- произвольное состояние цикла из $\Gamma$,  $k_0>0$. Единственным предположением было лишь невозможность выхода из цикла на следующем такте: $x_{0,  j} > L$.

Теперь рассмотрим переход из выходного состояния $(\Gamma_{N_1},  \varkappa_{N_1}) \hm= (\Gamma^{(k_0,  n_{k_0})},  x^{N_1})$,  $x_{3,  N_1} \leqslant L$,  цикла $k_0$ в состояние продления $(\Gamma_{N_1+1}, \varkappa_{N_1+1}) \hm= (\Gamma^{(0, r_1)},  x^{N_1+1})$,  где $r_1 \hm= h_1(\Gamma^{(k_0,  n_{k_0})},  x_{3, N_1})$ и 
\begin{multline*}
x^{N_1+1}=\left(\max{\{0,  x_{1, N_1} - \ell(0,  r_1, 1)\}};
\max{\{0,  x_{2,  N_1} - \ell(0,  r_1,  2)\}};x_{3,  N_1};\right.\\
\left.
x_{4,  N_1} + \min{\{x_{1,  N_1},  \ell(0,  r_1,  1)\}}\right).
\end{multline*}

Из формулы \eqref{transitionToProve} имеем
\begin{multline*}
\Pr (\{\omega\colon \Gamma_{N_1+1}=\Gamma^{(0,  r_1)}, \varkappa_{N_1+1}=x^{N_1+1} \}|\{\omega\colon  \Gamma_{N_1}=\Gamma^{(k_0,  n_{k_0})}, \varkappa_{N_1}=x^{N_1}\})=\\
=\widetilde{\varphi}_3(0,  r_1,  T^{(0,  r_1)}, x_{3,  N_1}, x_{3,  N_1})\times \\
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_1)})  \psi(a_2,  x_{4,  N_1},  p_{0,  r_1}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}}(x^{N_1},  x^{N_1+1},  0,  r_1) = {\mathbb A}_{\mathrm{trans}}^0 \cap {\mathbb A}_{\mathrm{trans}}^1\cap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(0,  r_1,  1),  x_{1,  N_1}+a_1}\} +x_{4,  N_1}-x_{4,  N_1+1} \},  \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_{1,  N_1+1} =\max{\{0,  x_{1, N_1}+a_1-\ell(0,  r_1,  1)\}}\}, \\
& {\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  x_{2,  N_1+1}=\max{\{0,  x_{2,  N_1}+a_2-\ell(0,  r_1,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0,  r_1,  T^{(0,  r_1)},  x_{3,  N_1},  x_{3,  N_1})=\\=(1-\delta_{x_{3,  N_1+1},  0}) \times\varphi_3(x_{3,  N_1+1} + \ell (0,  r_1,  3) - x_{3,  N_1}, T^{(0,  r_1)} )
+\delta_{x_{3,  N_1+1},  0} \varphi_3 (0,  T^{(0,  r_1)}) = \\=
(1-\delta_{x_{3,  N_1+1},  0}) \times\varphi_3(0, T^{(0,  r_1)} )
+\delta_{x_{3,  N_1+1},  0} \varphi_3 (0,  T^{(0,  r_1)}) = \varphi_3 (0,  T^{(0,  r_1)})> 0.
\end{multline*}
Значит, 
\begin{multline*}
\Pr (\{\omega\colon \Gamma_{N_1+1}=\Gamma^{(0,  r_1)}, \varkappa_{N_1+1}=x^{N_1+1} \}|\{\omega\colon  \Gamma_{N_1}=\Gamma^{(k_0,  n_{k_0})}, \varkappa_{N_1}=x^{N_1}\})\geqslant\\
\geqslant\varphi_3 (0, T^{(0,  r_1)})
\times
\varphi_1(0, T^{(0,  r_1)})  \psi(0,  x_{4,  N_1},  p_{0,  r_1}) > 0, 
\end{multline*}
и вероятность перейти из состояния $(\Gamma^{(k_0,  n_{k_0})},  x^{N_1})$ в состояние $ (\Gamma^{(0,  r_1)},  \hm{} x^{N_1+1})$ за один такт положительна.

Таким образом,  вероятность перейти из состояния $(\Gamma^{(k_0,  r_0)},  x^0)$,  $k_0>0$,  $x^0 \hm\in \mathbb{Z}_+^4$,  в состояние 
$$(\Gamma^{(0,  r_1)},  x^{N_1+1}),  \quad r_1=h_1(\Gamma^{(k_0,  n_{k_0})},  x_{3,  N_1}) \in \{1,  2,  \ldots,  n_0\}, $$
за $(N_1+1)$ шагов положительна. По предыдущей лемме существует такое число шагов $N_2 \geqslant 0$,  за которое можно перейти из состояния вида $(\Gamma^{(0, r_1)},  x^{N_1+1})$ в состояние $(\Gamma^{(0,  \tilde{r})},  (0,  0,  L\hm+1,  0))$,  $\tilde{r}=\overline{1,  n_0}$. Полагая $N=N_1+1+N_2$,  получаем утверждение леммы.
\end{proof}


Лемма~\ref{first:lemma} заключает о том,  что состояния вида $(\Gamma^{(0, \tilde{r})}, (0, 0, L+1, 0) )$ являются существенными. Наличие некоторого множества существенных состояний позволит в дальнейшем найти все оставшиеся существенные состояния.

\begin{lemma}\label{all:in:one}
Состояния вида 
$$(\Gamma^{(0,  \tilde{r})},  \tilde{x}),  \quad \tilde{r} = \overline{1,  n_0},  \tilde{x}=(0,  0,  L+1,  0), $$
достижимы из любых состояний системы,  то есть из состояний вида 
 $$(\Gamma^{(k_0,  r_0)},  x^0),  \quad k_0=\overline{0,  d},  r_0=\overline{1,  n_{k_0}},  x^0 \in \mathbb{Z}_+^4.$$
Таким образом,  состояния $(\Gamma^{(0,  \tilde{r})},  \tilde{x})$ являются существенными.
\label{first:lemma}
\end{lemma}
\begin{proof}
Для доказательства достаточно показать,  что существует такое натуральное число $N$,  что 
\begin{equation*}
\Pr(\{\omega\colon \Gamma_{N}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{N}=\tilde{x}\}|
\{\omega\colon \Gamma_{0}=\Gamma^{(k_0,  r_0)},  \varkappa_{0}=x^0\})>0.
\end{equation*}
В леммах \eqref{classification:arithm:1} и \eqref{classification:arithm:2} решен вопрос для всех начальных состояний,  кроме состояний вида $(\Gamma^{(0,  r_0)},  x^0)$,  $x_{3,  0}>L$. Но нетрудно проверить,  что на следующем такте (после состояния $(\Gamma^{(k_0,  r_0)},  x^0)$) с ненулевой вероятностью из этого состояния можно перейти в состояние цикла вида $(\Gamma^{(k_1,  r_1)}, x^1)$,  где $\Gamma^{(k_1,  r_1)} = h_3(r_0)$,  $k_1>0$,  и 
\begin{multline*}
x^{1}=\left(\max{\{0,  x_{1, 0} - \ell(k_1,  r_1, 1)\}};
\max{\{0,  x_{2, 0} - \ell(k_1,  r_1,  2)\}};\right.\\
\left.
\max{\{0,  x_{3,  0} - \ell(k_1,  r_1,  3)\}};
x_{4,  0} + \min{\{x_{1,  0},  \ell(k_1,  r_1,  1)\}}\right).
\end{multline*}


Действительно,  из формулы \eqref{transitionToProve} имеем
\begin{multline*}
\Pr (\{\omega\colon \Gamma_{1}=\Gamma^{(k_1,  r_1)}, \varkappa_{1}=x^1 \}| \{\omega\colon \Gamma_{0}=\Gamma^{(k_0,  r_0)}, \varkappa_0=x^0\})=\\
=\widetilde{\varphi}_3(k_1,  r_1,  T^{(k_1,  r_1)},  x_{3,  0}, \max{\{0,  x_{3,  0} - \ell(k_1,  r_1,  3)\}})\times \\
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(k_1,  r_1)})  \psi(a_2,  x_{4,  0},  p_{k_1,  r_1}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}}(x^0,  x^1,  k_1,  r_1) = {\mathbb A}_{\mathrm{trans}}^0 \cap {\mathbb A}_{\mathrm{trans}}^1\cap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(k_1,  r_1,  1),  x_{1,  0}+a_1}\} +x_{4,  0}- x_{4,  1}\}, \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_{1,  1}=\max{\{0,  x_{1,  0}+a_1-\ell(k_1,  r_1,  1)\}}\}, \\
& {\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  x_{2,  1} =\max{\{0,  x_{2,  0}+a_2-\ell(k_1,  r_1,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(k_1,  r_1,  T^{(k_1,  r_1)}, x_{3,  0}, \max{\{0,  x_{3,  0} - \ell(k_1,  r_1,  3)\}}) = (1-\delta_{x_{3,  1},  0}) \times \\\times\varphi_3(\max{\{0,  x_{3,  0} - \ell(k_1,  r_1,  3)\}} + \ell (k_1,  r_1,  3) - x_{3,  0},  T^{(k_1,  r_1)} ) 
+\\+\delta_{x_{3,  1},  0} \sum_{a=0}^{\ell(k_1,  r_1,  3)-x_{3,  0}}\varphi_3 (a,  T^{(k_1,  r_1)})>0.
\end{multline*}
Значит, 
\begin{multline*}
\Pr (\{\omega\colon \Gamma_{1}=\Gamma^{(k_1,  r_1)}, \varkappa_{1}=x^1\}|\{\omega\colon  \Gamma_{0}=\Gamma^{(k_0,  r_0)}, \varkappa_0=x^0\})\geqslant \\
\geqslant \widetilde{\varphi}_3(k_1,  r_1,  T^{(k_1,  r_1)},  x_{3,  0},  x_{3,  1})
\times
\varphi_1(0,  T^{(k_1,  r_1)})  \psi(0,  x_{4,  0},  p_{k_1,  r_1}) > 0.
\end{multline*}
Таким образом, вероятность за один такт перейти из состояния $(\Gamma^{(k_0,  r_0)},  x^0)$ в состояние $ (\Gamma^{(k_0,  r_0\oplus_{k_0}1)},  x^1)$ положительна.
Далее,  по лемме \eqref{classification:arithm:2} за $N_1$ шагов можно перейти в искомое конечное состояние $(\Gamma^{(0, \tilde{r} )},  (0,  0,  L+1,  0))$. Полагая $N=N_1+1$,  получаем утверждение леммы.
\end{proof}

В леммах \ref{classification:arithm:3},  \ref{classification:arithm:4},  \ref{classification:arithm:5} определяются состояния,  сообщающиеся с существенными состояниями $(\Gamma^{(0,  r_0)},  x^0)$,  $x_0=(0,  0,  L+1,  0)$,  $r_0=\overline{1,  n_0}$. Таким способом определится все множество существенных состояний. В частности,  лемма \ref{classification:arithm:3} касается состояний циклов.
\begin{lemma}\label{incycle:states}
Состояния вида 
\begin{align*}
    (\Gamma^{(\tilde{k},  \tilde{r})},  \tilde{x}),  \quad
&\tilde{x}=(0,  0,  \tilde{x}_3,  0)),  \tilde{x}_3\geqslant\max{\{0,  L+1-\sum_{s=1}^{\tilde{r}} \ell(\tilde{k},  s,  3)\}},  \\ &\tilde{r} = \overline{1,  n_{\tilde{k}}},  \tilde{k}>0,  \Gamma^{(\tilde{k},  1)}=h_3(r_0), 
\end{align*}
 достижимы из состояний вида
 $$(\Gamma^{(0,  r_0)},  x^0),  \quad x_0=(0,  0,  L+1,  0),  r_0=\overline{1,  n_0}.$$\label{classification:arithm:3}
\end{lemma}
\begin{proof}
Для доказательства достаточно показать,  что
существует такое натуральное число $N$,  что 
\begin{equation*}
\Pr(\{\omega\colon \Gamma_{N}=\Gamma^{(\tilde{k},  \tilde{r} )},  \varkappa_{N}=\tilde{x}\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\})>0.
\end{equation*}
Поскольку $h(\Gamma^{(0,  r_0)},  L+1) = \Gamma^{(\tilde{k},  1)}$,  то $\Gamma_1 = \Gamma^{(\tilde{k},  1)}$. Докажем,  что вероятность перехода за один такт из состояния $(\Gamma^{(0,  r_0)},  x^0)$ в состояние $(\Gamma^{(\tilde{k},  1)},  x^1)$,  $x^1 \hm= (0,  0,  \max{\{0,  L+1-\ell(\tilde{k},  1,  3)\}},  0)$,  положительна.
Действительно,  из формулы \eqref{transitionToProve} имеем
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{1}=\Gamma^{(\tilde{k},  1)},  \varkappa_{1}=x^1\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\})=\\
=\widetilde{\varphi}_3(\tilde{k},  1,  T^{(\tilde{k},  1)},  x_{3,  0}, \max{\{0,  x_{3,  0} - \ell(\tilde{k},  1,  3)\}}) \times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(\tilde{k},  1)})  \psi(a_2,  x_{4,  0},  p_{\tilde{k},  1}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}}(x^0,  x^1, \tilde{k},  1) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(\tilde{k},  1,  1),  x_{1,  0}+a_1}\} +x_{4,  0}- x_{4,  1}\}, \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_{1,  1}=\max{\{0, x_{1,  0}+a_1-\ell(k_1,  r_1,  1)\}}\}, \\
& {\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  x_{2,  1} =\max{\{0, x_{2,  0}+a_2-\ell(k_1,  r_1,  2)\}}\}.
\end{align*}
При $x_{1,  0} = x_{4,  0} = x_{4,  1} = 0$ множество ${\mathbb A}_{\mathrm{trans}}^0$ преобразуется следующим образом:
$$
{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(\tilde{k},  1,  1),  a_1}\}\}.
$$
При $x_{1,  0} = x_{1,  1} = 0$ множество ${\mathbb A}_{\mathrm{trans}}^1$ преобразуется следующим образом:
$$
{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon 0=\max{\{0,  a_1-\ell(k_1,  r_1,  1)\}}\}.
$$
И при $x_{2,  1}=x_{2,  0} = 0$ множество $ {\mathbb A}_{\mathrm{trans}}^2 $ преобразуется следующим образом:
$$
{\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  0 =\max{\{0,  a_2-\ell(k_1,  r_1,  2)\}}\}.
$$
Тем самым элемент $(a_1,  a_2) = (0,  0)$ принадлежит множеству ${\mathbb A}_{\mathrm{trans}}(x^0,  x^1,  \tilde{k},  1)$. Далее,  из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(\tilde{k},  1,  T^{(\tilde{k},  1)},  x_{3,  0}, \max{\{0,  x_{3,  0} - \ell(\tilde{k},  1,  3)\}})= (1-\delta_{x_{3,  1}, 0}) \times \\\times\varphi_3(\max{\{0,  x_{3,  0} - \ell(\tilde{k},  1,  3)\}} + \ell (\tilde{k},  1,  3) - x_{3,  0},  T^{(\tilde{k},  1)} ) 
+\\+\delta_{x_{3,  1},  0} \sum_{a=0}^{\ell(\tilde{k},  1,  3)-x_{3,  0}} \varphi_3 (a,  T^{(\tilde{k},  1)})>0.
\end{multline*}
Значит, 
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{1}=\Gamma^{(\tilde{k},  1)},  \varkappa_{1}=x^1\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\})\geqslant \\
\geqslant \widetilde{\varphi}_3(\tilde{k}, 1, T^{(\tilde{k},  1)},  x_{3,  0}, \max{\{0,  x_{3,  0} - \ell(\tilde{k},  1,  3)\}})
\times
\varphi_1(0,  T^{(\tilde{k},  1)})  \psi(0,  x_{4,  0},  p_{\tilde{k},  1}) > 0, 
\end{multline*}
Теперь рассмотрим переход из состояния $x^j$ в состояние $x^{j+1}$,  $j=\overline{1,  \tilde{r}-2}$,  где
\begin{equation*}
x^j = (0,  0,  \max{\{0,  L+1-\sum_{s=1}^{j} \ell(\tilde{k},  s,  3)\}},  0).
\end{equation*}
Из формулы \eqref{transitionToProve} имеем
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{j+1}=\Gamma^{(\tilde{k},  j+1)},  \varkappa_{j+1}=x^{j+1}\}|
\{\omega\colon \Gamma_{j}=\Gamma^{(\tilde{k},  j)},  \varkappa_{j}=x^j\})=\\
=\widetilde{\varphi}_3(\tilde{k},  j+1,  T^{(\tilde{k},  j+1)},  x_{3, j},  \max{\{0,  x_{3,  j} - \ell(\tilde{k},  j+1,  3)\}})\times \\
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(\tilde{k},  j+1)})  \psi(a_2,  x_{4,  j},  p_{\tilde{k},  j+1}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}}(x^j,  x^{j+1},  \tilde{k},  j+1) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(\tilde{k},  j+1,  1),  x_{1,  j}+a_1}\} +x_{4,  j}- x_{4,  j+1}\}, \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_{1,  j+1}=\max{\{0, x_{1,  j}+a_1-\ell(\tilde{k},  j+1, 1)\}}\}, \\
 &{\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  x_{2,  j+1} =\max{\{0,  x_{2,  j}+a_2-\ell(\tilde{k},  j+1, 2)\}}\}, 
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(\tilde{k},  j+1,  T^{(\tilde{k},  j+1)},  x_{3,  j},  \max{\{0,  x_{3,  j} - \ell(\tilde{k},  j+1,  3)\}})= (1-\delta_{x_{3,  j+1},  0}) \times \\\times\varphi_3(\max{\{0,  x_{3,  j} - \ell(\tilde{k},  j+1,  3)\}} + \ell (\tilde{k},  j+1,  3) - x_{3,  j}, T^{(\tilde{k},  j+1)} ) 
+\\+\delta_{x_{3,  j+1},  0} \sum_{a=0}^{\ell(\tilde{k},  j+1,  3)-x_{3,  j}}\varphi_3 (a,  T^{(\tilde{k},  j+1)})>0.
\end{multline*}
Значит, 
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{j+1}=\Gamma^{(\tilde{k},  j+1)},  \varkappa_{j+1}=x^{j+1}\}|\{\omega\colon 
\Gamma_{j}=\Gamma^{(\tilde{k},  j)},  \varkappa_{j}=x^j\})\geqslant \\
\geqslant \widetilde{\varphi}_3(\tilde{k},  j+1,  T^{(\tilde{k},  j+1)},  x_{3, j},  \max{\{0,  x_{3,  j} - \ell(\tilde{k},  j+1,  3)\}})
\times \\ \times
\varphi_1(0,  T^{(\tilde{k},  j+1)})  \psi(0,  x_{4,  j},  p_{\tilde{k},  j+1}) > 0. 
\end{multline*}
Следовательно,  все переходы в цепочке
\begin{equation*}
(\Gamma^{(0, r_0)}, x^0) \rightarrow (\Gamma^{(\tilde{k}, 1)}, x^1) \rightarrow (\Gamma^{(\tilde{k}, 2)}, x^1) \rightarrow \ldots  \rightarrow
(\Gamma^{(\tilde{k}, \tilde{r}-1)}, x^{\tilde{r} - 1}) 
\end{equation*}
имеют ненулевую вероятность. В завершении доказательства осталось рассмотреть переход в конечное состояние:
\begin{align}
    (\Gamma^{(\tilde{k}, \tilde{r}- 1)}, x^{\tilde{r} - 1})  \rightarrow (\Gamma^{(\tilde{k},  \tilde{r})},  \tilde{x}),  \quad \text{ если } \tilde{r} > 1, 
    \label{classification:3:case:1}\\
    (\Gamma^{(0, r_0)}, x^0)  \rightarrow (\Gamma^{(\tilde{k},  \tilde{r})},  \tilde{x}),  \quad \text{ если }  \tilde{r} = 1.
    \label{classification:3:case:2}
\end{align}

В случае \eqref{classification:3:case:1},  то есть $\tilde{r} > 1$,   из формулы \eqref{transitionToProve} опять имеем
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{\tilde{r}}=\Gamma^{(\tilde{k},  \tilde{r})},  \varkappa_{\tilde{r}}=\tilde{x}\}|
\{\omega\colon \Gamma_{\tilde{r}-1}=\Gamma^{(\tilde{k},  \tilde{r}- 1)},  \varkappa_{\tilde{r}-1}=x^{\tilde{r}-1}\})=\\
=\widetilde{\varphi}_3(\tilde{k},  \tilde{r},  T^{(\tilde{k},  \tilde{r})},  x_{3, \tilde{r}-1},  \tilde{x}_3) 
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(\tilde{k},  \tilde{r})})  \psi(a_2,  x_{4,  \tilde{r}-1},  p_{\tilde{k},  \tilde{r}})=\\
=
\widetilde{\varphi}_3(\tilde{k},  \tilde{r},  T^{(\tilde{k},  \tilde{r})},  \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}-1} \ell(\tilde{k},  s,  3)\}} ,  \tilde{x}_3) 
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(\tilde{k},  \tilde{r})})  \psi(a_2,  0,  p_{\tilde{k},  \tilde{r}}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$.
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(\tilde{k},  \tilde{r},  T^{(\tilde{k},  \tilde{r})},  \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}-1} \ell(\tilde{k},  s,  3)\}} ,  \tilde{x}_3)= (1-\delta_{\tilde{x}_3,  0}) \times \\
\times\varphi_3(\tilde{x}_3 + \ell (\tilde{k},  \tilde{r},  3) - \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}-1} \ell(\tilde{k},  s,  3)\}}, T^{(\tilde{k},  \tilde{r})} ) 
+\\+\delta_{\tilde{x}_3,  0} \sum_{a=0}^{\ell(\tilde{k},  \tilde{r},  3)-\tilde{x}_3}\varphi_3 (a,  T^{(\tilde{k},  \tilde{r})})>0, 
\end{multline*}
поскольку $\tilde{x}_3\geqslant\max{\{0,  L+1-\sum_{s=1}^{\tilde{r}} \ell(\tilde{k},  s,  3)\}}$ и 
\begin{multline*}
    \tilde{x}_3 + \ell (\tilde{k},  \tilde{r},  3) - \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}-1} \ell(\tilde{k},  s,  3)\}} \geqslant \\
    \geqslant \tilde{x}_3 - \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}} \ell(\tilde{k},  s,  3)\}} \geqslant 0.
\end{multline*}
Значит, 
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{\tilde{r}}=\Gamma^{(\tilde{k},  \tilde{r})},  \varkappa_{\tilde{r}}=\tilde{x}\}|\{\omega\colon 
\Gamma_{\tilde{r}-1}=\Gamma^{(\tilde{k},  \tilde{r}-1)},  \varkappa_{\tilde{r}-1}=x^{\tilde{r}-1}\})\geqslant \\
\geqslant \widetilde{\varphi}_3(\tilde{k},  \tilde{r},  T^{(\tilde{k},  \tilde{r})},  \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}-1} \ell(\tilde{k},  s,  3)\}} ,  \tilde{x}_3)
\times \\ \times
\varphi_1(0,  T^{(\tilde{k},  \tilde{r})})  \psi(0,  0,  p_{\tilde{k},  \tilde{r}}) > 0.
\end{multline*}

В другом случае \eqref{classification:3:case:2},  то есть $\tilde{r} = 1$,   из формулы \eqref{transitionToProve} и того факта,  что  $h(\Gamma^{(0,  r_0)},  L+1) = \Gamma^{(\tilde{k},  1)}$,  следует
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{\tilde{r}}=\Gamma^{(\tilde{k},  \tilde{r})},  \varkappa_{\tilde{r}}=\tilde{x}\}|
\{\omega\colon \Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^{0}\})=\\
=\widetilde{\varphi}_3(\tilde{k},  \tilde{r},  T^{(\tilde{k},  \tilde{r})},  x_{3, 0},  \tilde{x}_3) 
\times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(\tilde{k},  \tilde{r})})  \psi(a_2,  x_{4, 0},  p_{\tilde{k},  \tilde{r}})=\\
=
\widetilde{\varphi}_3(\tilde{k},  \tilde{r},  T^{(\tilde{k},  \tilde{r})},  \max{\{0,  L+1-\sum_{s=1}^{\tilde{r}-1} \ell(\tilde{k},  s,  3)\}} ,  \tilde{x}_3) 
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(\tilde{k},  \tilde{r})})  \psi(a_2,  0,  p_{\tilde{k},  \tilde{r}}) > 0, 
\end{multline*}
так как последняя вероятность уже рассмотрена выше.

Следовательно,  все переходы в цепочке
\begin{multline*}
(\Gamma^{(0, r_0)}, x^0) \rightarrow (\Gamma^{(\tilde{k}, 1)}, x^1) \rightarrow (\Gamma^{(\tilde{k}, 2)}, x^1) \rightarrow \ldots \\ 
\ldots \rightarrow
(\Gamma^{(\tilde{k}, \tilde{r}-1)}, x^{\tilde{r} - 1})  \rightarrow  (\Gamma^{(\tilde{k},  \tilde{r})},  \tilde{x}),  \quad \tilde{r} > 1, 
\end{multline*}
и переход
\begin{equation*}
(\Gamma^{(0, r_0)}, x^0) \rightarrow (\Gamma^{(\tilde{k},  \tilde{r})},  \tilde{x}),  \quad \tilde{r} = 1, 
\end{equation*}
имеют ненулевую вероятность и лемма доказана. 

\end{proof}

\begin{lemma}
Состояния вида 
\begin{equation}
    (\Gamma^{(0,  \tilde{r})},  \tilde{x}),  \quad 
\tilde{x}=(0,  0,  \tilde{x}_3, 0),  \tilde{x}_3 \geqslant \max{\{0,  L+1-\sum_{s=1}^{n_{\tilde{k}}} \ell(\tilde{k},  s,  3)\}}, 
\label{classification:arithm:4:eq}
\end{equation}
где $\tilde{k}=\overline{1,  d},  \tilde{r} = \overline{1,  n_0}$,  достижимы из состояний вида 
\begin{equation*}
(\Gamma^{(0,  r_0)},  x^0),  \quad x_0=(0,  0,  L+1,  0),  r_0=\overline{1,  n_0}.
\end{equation*}
\label{classification:arithm:4}
\end{lemma}
\begin{proof}
Для доказательства достаточно показать,  что существует такое натуральное число $N$,  что 
\begin{equation*}
\Pr(\{\omega\colon \Gamma_{N}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{N}=\tilde{x}\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0}=x^0\})>0.
\end{equation*}
Действительно,  по лемме \ref{all:in:one} существует такое натуральное число $N_1$,  что за $N_1$ шагов из состояния $(\Gamma^{(0,  r_0)},  x^0)$ можно перейти в состояние  $(\Gamma^{(0,  r_1)},  x^1)$,  $\Gamma^{(\tilde{k},  1)}=h_3(r_1)$,  $x^1=(0,  0,  L+1,  0)$. По лемме \ref{incycle:states} существует такое число шагов $N_2$,  за которое можно перейти далее в состояние $(\Gamma^{(\tilde{k},  n_{\tilde{k}})},  x^2)$,  
\begin{equation*}
x^2=(0,  0,  \max{\{0,  L+1-\sum_{s=1}^{n_{\tilde{k}}} \ell(\tilde{k},  s,  3)\}},  0).
\end{equation*}

Теперь достаточно показать,  что из состояния $(\Gamma^{(\tilde{k},  n_{\tilde{k}})},  x^2)$ можно перейти за один шаг в состояние $(\Gamma^{(0,  r_3)},  x^3)$,  $r_3=h_1(\Gamma^{(\tilde{k},  n_{\tilde{k}})})$,  $x^3=x^2$,  поскольку по лемме \ref{classification:arithm:1} за конечное число $N_3$ шагов из последнего можно перейти в состояние $(\Gamma^{(0,  \tilde{r})},  \tilde{x})$.

Итак,  из формулы \eqref{transitionToProve} имеем
\begin{multline*}
\Pr( A_{N_1+N_2+1} (0,  r_3,  x^{3})
|A_{N_1+N_2} (\tilde{k},  n_{\tilde{k}},  x^{2}))
=\widetilde{\varphi}_3(0,  r_3,  T^{(0,  r_3)},  x_{3,  2},  x_{3,  3}) \times\\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_3)})  \psi(a_2,  x_{4,  2},  p_{0,  r_3}) =\\
=\widetilde{\varphi}_3(0,  r_3,  T^{(0,  r_3)},  x_{3,  2},  x_{3,  2}) \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1, T^{(0, r_3)})  \psi(a_2,  0,  p_{0,  r_3}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}}(x^2,  x^{3},  0,  r_3) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(0,  r_3,  1),  x_{1,  2}+a_1}\} +x_{4,  2}- x_{4,  3}\}, \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_{1,  3}=\max{\{0,  x_{1,  2}+a_1-\ell(0,  r_3,  1)\}}\}, \\
& {\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  x_{2,  3} =\max{\{0,  x_{2,  2}+a_2-\ell(0,  r_3,  2)\}}\}. 
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0,  r_3,  T^{(0,  r_3)},  x_{3,  2}, x_{3,  2})=\\
= (1-\delta_{x_{3,  2},  0}) \times \varphi_3(x_{3,  2} - x_{3,  2},  T^{(0,  r_3)} ) 
+\delta_{x_{3,  2},  0} \varphi_3 (0,  T^{(0,  r_3)}),
\end{multline*}
и после упрощений получим:
\begin{equation*}
\widetilde{\varphi}_3(0,  r_3,  T^{(0,  r_3)},  x_{3,  2},  x_{3,  2})=\varphi_3(0,  T^{(0,  r_3)} ) >0.
\end{equation*}
Значит, 
\begin{multline*}
\!\!\Pr(\{\omega\colon\!\! \Gamma_{N_1+N_2+1}=\Gamma^{(0,  r_3)},  \varkappa_{N_1+N_2+1}=x^{3}\}|\{\omega\colon\!
\Gamma_{N_1+N_2}=\Gamma^{(\tilde{k},  n_{\tilde{k}})},  \varkappa_{N_1+N_2}\!=\!x^2\})\geqslant \\
\geqslant \widetilde{\varphi}_3(0,  r_3,  T^{(0,  r_3)},  x_{3,  2},  x_{3,  2})
\times
\varphi_1(0,  T^{(0,  r_3)})  \psi(0,  0,  p_{0,  r_3}) > 0.
\end{multline*}

Таким образом,  полагая $N=N_1+N_2+1+N_3$,  получаем утверждение леммы.
\end{proof}

Взяв в выражении~\eqref{classification:arithm:4:eq} в качестве $\tilde{k}$ такое, которое максимизирует сумму $\sum_{s=1}^{n_{\tilde{k}}} \ell(\tilde{k},  s,  3)$, получим лемму~\ref{classification:arithm:5}.
\begin{lemma}
Состояния вида 
$$
(\Gamma^{(0,  \tilde{r})},  \tilde{x}), 
$$
где 
$$
\tilde{x}=(0,  0,  \tilde{x}_3,  0),  \tilde{x}_3\geqslant \max{\{0,  L+1-\max_{k=\overline{1,  d}}{\{ \sum_{s=1}^{n_k}\ell(k,  s,  3)\}}\}}, 
\tilde{r} = \overline{1,  n_0}, 
$$
достижимы из состояний вида  
\begin{equation*}
(\Gamma^{(0,  r_0)},  x^0),  \quad x^0=(0,  0,  L+1,  0),   r_0=\overline{1,  n_0}.
\end{equation*}
\label{classification:arithm:5}
\end{lemma}
\begin{lemma}
Если состояния вида
$$
(\Gamma^{(0,  \tilde{r})},  (0,  0,  \min\{L,  \tilde{x}_3\},  0)),  \quad \tilde{r}=\overline{1, n_0},  \tilde{x}_3 \geqslant 0, 
$$
достижимы из начальных состояний вида
$$
(\Gamma^{(0,  r_0)},  x^0),  \quad x^0=(0,  0,  L+1,  0),  r_0=\overline{1, n_0}, 
$$
то тогда из начальных состояний достижимы и состояния вида
$$
(\Gamma^{(0,  \tilde{r})},  \tilde{x}),  \quad
 \tilde{x} \in \{y = (y_1,  y_2,  y_3,  y_4) \in Z_+^4\colon y_3=\tilde{x}_3; (y_1 > 0)\rightarrow (y_4\geqslant \ell(0,  \tilde{r},  1))\}.
 $$
 
\label{classification:arithm:6}
\end{lemma}

\begin{proof}

Для доказательства достаточно показать,  что существует такое число $N$ шагов,  что
\begin{equation*}
\Pr(\{\omega\colon \Gamma_{N}=\Gamma^{(0,  \tilde{r} )},  \varkappa_{N}=\tilde{x}\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(0,  r_0)},  \varkappa_{0} = x^0\})>0.
\end{equation*}
Опираясь на рассуждения предыдущих лемм,  доказательство проведем в три этапа. 

Первый этап. Из сделанных предположений следует существование такого натурального числа $N_1$,  что 
\begin{equation*}
\!\!\!\Pr(\{\omega\colon \Gamma_{N_1}=\Gamma^{(0, r_0\oplus_0 N_1)},  \varkappa_{N_1}=(0, 0, x_3, 0)\}|\{\omega\colon 
\Gamma_{0}=\Gamma^{(0, r_0)},  \varkappa_{0}=x^0\})>0, 
\end{equation*}
где $x_3=\min\{L, \tilde{x}_3\}$ и $r_0\oplus_0 N_1 = \tilde{r}$.


Второй этап. Докажем,  что за $N_2$ шагов возможен переход
\begin{multline*}
(\Gamma^{(0,  r_1)},  (0,  0,  \min\{L,  \tilde{x}_3\},  0)) \rightarrow \\ 
\rightarrow
    (\Gamma^{(0, r_2)},  (x_4 + \tilde{x}_2 - \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1), 0, x_3, \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1))), 
\end{multline*}
где 
\begin{align*}
r_1 &= \tilde{r},  \quad r_2=\tilde{r}\oplus_0 N_2,  \quad r_3=r_2\oplus_0 2 = \tilde{r}, \\
x_4&=\tilde{x}_4 - (1 - \delta_{\tilde{x}_1, 0})\ell(0, \tilde{r}, 1) + \ell(0, r_3, 2), 
\end{align*}
причем $N_2$ таково,  что 
\begin{equation*}
\sum_{s=1}^{N_2} \ell(0, r_1\oplus_0 s, 1) < x_4 + \tilde{x}_2 \leqslant \sum_{s=1}^{N_2+1} \ell(0, r_1 \oplus_0 s, 1).
\end{equation*}


Введем последовательность векторов
\begin{align*}
    x^1 &= (0,  0, x_3,  0), \\
    x^2 &= (x_4 + \tilde{x}_2 - \ell(0, r_1 \oplus_0 1, 1),  0,  x_3,  \ell(0, r_1 \oplus_0 1, 1)), \\
    x^3 &= (x_4 + \tilde{x}_2 - \sum_{s=1}^{2} \ell(0, r_1 \oplus_0 s, 1),  0,  x_3, \sum_{s=1}^{2} \ell(0, r_1 \oplus_0 s, 1)), \\
    &\ldots,  \\
    x^{N_2 + 1} &= (x_4 + \tilde{x}_2 - \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1),  0,  x_3, \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1)).
\end{align*}
и рассмотрим переход 
$$
(\Gamma^{(0,  r_1)},  x^1) \rightarrow (\Gamma^{(0,  r_1 \oplus_0 1)},  x^2).
$$
Из формулы \eqref{transitionToProve} и того факта,  что  $h(\Gamma^{(0,  r_1)},   \min\{L,  \tilde{x}_3\}) = \Gamma^{(0,  r_1 \oplus_0 1)}$,  следует
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{N_1 + 1}=\Gamma^{(0,  r_1 \oplus_0 1)},  \varkappa_{N_1 + 1}=x^{2}\}|
\{\omega\colon \Gamma_{N_1}=\Gamma^{(0,  r_1)},  \varkappa_{N_1}=x^{1}\})=\\
=\widetilde{\varphi}_3(0,  r_1 \oplus_0 1,  T^{(0,  r_1 \oplus_0 1)},  \min\{L,  \tilde{x}_3\},  x_3)
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_1 \oplus_0 1)})  \psi(a_2,  0,  p_{0,  r_1 \oplus_0 1}),
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(x_4 + \tilde{x}_2,  0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
&{\mathbb A}_{\mathrm{trans}}(x^1,  x^2,  0,  r_1 \oplus_0 1) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2, \\
&{\mathbb A}_{\mathrm{trans}}^0 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 = \min{\{\ell(0,  r_1 \oplus_0 1,  1),  a_1}\} -\ell(0, r_1 \oplus_0 1, 1)\}, \\
&{\mathbb A}_{\mathrm{trans}}^1 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_4 + \tilde{x}_2 - \ell(0, r_1 \oplus_0 1, 1)=\max{\{0,  a_1-\ell(0,  r_1 \oplus_0 1,  1)\}}\}, \\
& {\mathbb A}_{\mathrm{trans}}^2 = \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  0 =\max{\{0,  a_2-\ell(0,  r_1 \oplus_0 1,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0, r_1 \oplus_0 1,  T^{(0, r_1 \oplus_0 1)},  x_{3,  1}, x_{3,  2})= \\
=\widetilde{\varphi}_3(0, r_1 \oplus_0 1,  T^{(0, r_1 \oplus_0 1)},  \min\{L,  \tilde{x}_3\},  \min\{L,  \tilde{x}_3\})=\\
= (1-\delta_{x_3,  0}) \times \varphi_3(\min\{L,  \tilde{x}_3\} - \min\{L,  \tilde{x}_3\},  T^{(0, r_1 \oplus_0 1)} ) +\delta_{x_3,  0} \varphi_3 (0,  T^{(0, r_1 \oplus_0 1)}) = \\
=  (1-\delta_{x_3,  0}) \times \varphi_3(0,  T^{(0, r_1 \oplus_0 1)} ) +\delta_{x_3,  0} \varphi_3 (0,  T^{(0, r_1 \oplus_0 1)}) =  \varphi_3(0,  T^{(0, r_1 \oplus_0 1)} ) > 0.
\end{multline*}
И поскольку 
\begin{equation*}
\varphi_1(x_4 + \tilde{x}_2,  T^{(0,  r_1 \oplus_0 1)}) > 0,  \quad \psi(0,  0,  p_{0,  r_1 \oplus_0 1}) > 0, 
\end{equation*}
то, 
\begin{multline*}
\Pr(\{\omega\colon \Gamma_{N_1 + 1}=\Gamma^{(0,  r_1 \oplus_0 1)},  \varkappa_{N_1 + 1}=x^{2}\}|
\{\omega\colon \Gamma_{N_1}=\Gamma^{(0,  r_1)},  \varkappa_{N_1}=x^{1}\})\geqslant \\
\geqslant \widetilde{\varphi}_3(0, r_1 \oplus_0 1,  T^{(0, r_1 \oplus_0 1)},  x_{3,  1}, x_{3,  2})
\times
\varphi_1(x_4 + \tilde{x}_2,  T^{(0,  r_1 \oplus_0 1)}) \psi(0,  0,  p_{0,  r_1 \oplus_0 1})  > 0.
\end{multline*}
Теперь рассмотрим переход 
$$
(\Gamma^{(0,  r_1 \oplus_0 j)},  x^{j+1}) \rightarrow (\Gamma^{(0,  r_1 \oplus_0 j+1)},  x^{j+2}),  \quad j=\overline{1, N_2 - 1}.
$$
Из формулы \eqref{transitionToProve} и того факта,  что $h(\Gamma^{(0,  r_1 \oplus_0 j)},  x_3) = \Gamma^{(0,  r_1 \oplus_0 j + 1 )}$,  следует
\begin{multline*}
\Pr( A_{N_1 + j + 1} (0,  r_1 \oplus_0 j + 1,  x^{j+2})
|A_{N_1 + j} (0,  r_1 \oplus_0 j,  x^{j+1}))
=\\
=\widetilde{\varphi}_3(0,  r_1 \oplus_0 j + 1,  T^{(0,  r_1 \oplus_0 j + 1)},  \min\{L,  \tilde{x}_3\},  \min\{L,  \tilde{x}_3\}) 
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_1 \oplus_0 j + 1)}) \psi(a_2,  \sum_{s=1}^{j} \ell(0, r_1 \oplus_0 s, 1) ,  p_{0,  r_1 \oplus_0 j + 1}),
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0, 0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
{\mathbb A}_{\mathrm{trans}}&(x^{j+1},  x^{j+2},  0,  r_1 \oplus_0 j + 1) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2, \\
{\mathbb A}_{\mathrm{trans}}^0 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 =\\=& \min{}\{\ell(0,  r_1 \oplus_0 j + 1,  1),  x_4 + \tilde{x}_2 - \sum_{s=1}^{j} \ell(0, r_1 \oplus_0 s, 1) + a_1\}  -\\
-&\ell(0, r_1 \oplus_0 j + 1, 1)\}, \\
{\mathbb A}_{\mathrm{trans}}^1 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon x_4 + \tilde{x}_2 - \sum_{s=1}^{j + 1} \ell(0, r_1 \oplus_0 s, 1) =\\
=&\max{\{0,  x_4 + \tilde{x}_2 - \sum_{s=1}^{j} \ell(0, r_1 \oplus_0 s, 1) + a_1-\ell(0,  r_1 \oplus_0 j + 1,  1)\}}\}, \\
 {\mathbb A}_{\mathrm{trans}}^2 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  0 = \max{\{0,  a_2-\ell(0,  r_1 \oplus_0 j + 1,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0, r_1 \oplus_0 j + 1,  T^{(0, r_1 \oplus_0 j + 1)},  x_{3,  j+1}, x_{3,  j+2})=\\
=\widetilde{\varphi}_3(0, r_1 \oplus_0 j + 1,  T^{(0, r_1 \oplus_0 j + 1)},  \min\{L,  \tilde{x}_3\},  \min\{L,  \tilde{x}_3\})=\\
= (1-\delta_{\min\{L,  \tilde{x}_3\},  0}) \times \varphi_3(\min\{L,  \tilde{x}_3\} - \min\{L,  \tilde{x}_3\},  T^{(0,  0, r_1 \oplus_0 j + 1)} ) +\\
+\delta_{\min\{L,  \tilde{x}_3\},  0} \varphi_3 (0,  T^{(0, r_1 \oplus_0 j + 1)}) = (1-\delta_{\min\{L,  \tilde{x}_3\},  0}) \times \varphi_3(0,  T^{(0,  0, r_1 \oplus_0 j + 1)} ) +\\
+\delta_{\min\{L,  \tilde{x}_3\},  0} \varphi_3 (0,  T^{(0, r_1 \oplus_0 j + 1)}) = \varphi_3(0,  T^{(0,  0, r_1 \oplus_0 j + 1)} ) > 0.
\end{multline*}
И поскольку 
\begin{equation*}
\varphi_1(0,  T^{(0,  r_1 \oplus_0 j +  1)}) > 0,  \quad \psi(0,  \sum_{s=1}^{j} \ell(0, r_1 \oplus_0 s, 1),  p_{0,  r_1 \oplus_0 j+1}) > 0, 
\end{equation*}
то
\begin{multline*}
\Pr( A_{N_1 + j + 1} (0,  r_1 \oplus_0 j + 1,  x^{j+2})
|A_{N_1 + j} (0,  r_1 \oplus_0 j,  x^{j+1}))
\geqslant \\
\geqslant \widetilde{\varphi}_3(0, r_1 \oplus_0 j + 1,  T^{(0, r_1 \oplus_0 j + 1)},  x_{3,  j + 1}, x_{3,  j + 2})
\varphi_1(0,  T^{(0,  r_1 \oplus_0 j + 1)})\times \\
\times\psi(0,  \sum_{s=1}^{j} \ell(0, r_1 \oplus_0 s, 1),  p_{0,  r_1 \oplus_0 j + 1})  > 0.
\end{multline*}
Таким образом, 
\begin{equation*}
\Pr(\{\omega\colon \Gamma_{N_1+N_2}=\Gamma^{(0, r_2)},  \varkappa_{N_1+N_2}=x^{N_2 + 1})\}|\{\omega\colon 
\Gamma_{N_1}=\Gamma^{(0, r_1)},  \varkappa_{N_1}=x^{1}\})>0.
\end{equation*}
На заключительном,  третьем этапе докажем,  что вероятности
\begin{equation*}
\Pr(A_{N_1+N_2+1}(0, r_2\oplus_0 1, x^{N_2+2})|A_{N_1+N_2}(0, r_2, x^{N_2 + 1}) ), 
\end{equation*}
и 
\begin{equation*}
\Pr(A_{N_1+N_2+2}(0, r_2\oplus_0 2, x^{N_2+3})|A_{N_1+N_2+1}(0, r_2\oplus_0 1, x^{N_2+2}) )
%\\ \Pr(\{\omega\colon \Gamma_{N_1+N_2+2}=\Gamma^{(0, r_2\oplus 2)},  \varkappa_{N_1+N_2+2}=x^{N_1+N_2+2}\}|\\\{\omega\colon \Gamma_{N_1+N_2+1}=\Gamma^{(0, r_3\oplus 1)},  \varkappa_{N_1+N_2+1}=x^{N_1+N_2+1}\}), 
\end{equation*}
положительны.  Здесь 
\begin{equation*}
x^{N_2 + 2} = (0, 0, x_3, \tilde{x}_2+x_4),  \quad x^{N_2 + 3} = \tilde{x}.
\end{equation*}
Итак,  рассмотрим переход 
$$
(\Gamma^{(0,  r_2)},  x^{N_2+1}) \rightarrow (\Gamma^{(0,  r_2 \oplus_0 1)},  x^{N_2+2}).
$$
Из формулы \eqref{transitionToProve} и того факта,  что $h(\Gamma^{(0,  r_2)},  x_3) = \Gamma^{(0,  r_2 \oplus_0 1 )}$,  следует
\begin{multline*}
\Pr( A_{N_1 + N_2 + 1} (0,  r_2 \oplus_0 1,  x^{N_2+2})
|A_{N_1 + N_2} (0,  r_2,  x^{N_2 + 1}) )
=\\
=\widetilde{\varphi}_3(0,  r_2 \oplus_0 1,  T^{(0,  r_2 \oplus_0 1)},  \min\{L,  \tilde{x}_3\},  \min\{L,  \tilde{x}_3\}) 
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_2 \oplus_0 1)}) \psi(a_2,  \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1) ,  p_{0,  r_2 \oplus_0  1}).
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент $(a_1,  a_2)\hm=(0, 0)$,  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{equation*}
    {\mathbb A}_{\mathrm{trans}}(x^{N_2+1},  x^{N_2+2},  0,  r_2 \oplus_0 1) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2,
\end{equation*}
\begin{align*}
{\mathbb A}_{\mathrm{trans}}^0 =& \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 =\\
=&\min{\{\ell(0,  r_2 \oplus_0 1,  1),  x_4 + \tilde{x}_2 - \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1) + a_1}\}   + \\
+&\sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1) -\tilde{x}_2 - x_4 \}, \\
{\mathbb A}_{\mathrm{trans}}^1 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon 0 =\\
&= \max{\{0,  x_4 + \tilde{x}_2 - \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1) + a_1-\ell(0,  r_2 \oplus_0 1,  1)\}}\}, \\
{\mathbb A}_{\mathrm{trans}}^2 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  0 = \max{\{0,  a_2-\ell(0,  r_2 \oplus_0 1,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0, r_2 \oplus_0 1,  T^{(0, r_2 \oplus_0 1)},  x_{3,  N_2+1}, x_{3,  N_2+2})= \\
=\widetilde{\varphi}_3(0, r_2 \oplus_0 1,  T^{(0, r_2 \oplus_0 1)},  \min\{L,  \tilde{x}_3\},  \min\{L,  \tilde{x}_3\})=\\
= (1-\delta_{\min\{L,  \tilde{x}_3\},  0}) \times \varphi_3(\min\{L,  \tilde{x}_3\} - \min\{L,  \tilde{x}_3\},  T^{(0,  0, r_2 \oplus_0 1)} ) +\\
+\delta_{\min\{L,  \tilde{x}_3\},  0} \varphi_3 (0,  T^{(0, r_2 \oplus_0 1)})
= (1-\delta_{\min\{L,  \tilde{x}_3\},  0}) \times \varphi_3(0,  T^{(0,  0, r_2 \oplus_0 1)} ) +\\
+\delta_{\min\{L,  \tilde{x}_3\},  0} \varphi_3 (0,  T^{(0, r_2 \oplus_0 1)}) = \varphi_3(0,  T^{(0,  0, r_2 \oplus_0 1)} ) > 0.
\end{multline*}
И поскольку 
\begin{equation*}
\varphi_1(0,  T^{(0,  r_2 \oplus_0 1)}) > 0,  \quad \psi(0,  \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1),  p_{0,  r_2 \oplus_0 1}) > 0, 
\end{equation*}
то  
\begin{multline*}
\Pr( A_{N_1 + N_2 + 1} (0,  r_2 \oplus_0 1,  x^{N_2+2})
|A_{N_1 + N_2} (0,  r_2,  x^{N_2 + 1}) )
\geqslant \\
\geqslant \widetilde{\varphi}_3(0, r_2 \oplus_0 1,  T^{(0, r_2 \oplus_0 1)},  x_{3,  N_2 + 1}, x_{3,  N_2 + 2})
\varphi_1(0,  T^{(0,  r_2 \oplus_0 1)})\times\\
\times\psi(0,  \sum_{s=1}^{N_2} \ell(0, r_1 \oplus_0 s, 1),  p_{0,  r_2 \oplus_0 1})  > 0.
\end{multline*}
% \tilde{x} \in \{y = (y_1,  y_2,  y_3,  y_4) \in Z_+^4\colon y_3=\tilde{x}_3; (y_1 > 0)\rightarrow (y_4\geqslant \ell(0,  \tilde{r},  1))\}.
%x^{N_2 + 2} = (0, 0, x_3, \tilde{x}_2+x_4),  \quad x^{N_2 + 3} = \tilde{x}.
В завершении доказательства,  рассмотрим переход 
$$
(\Gamma^{(0,  r_2 \oplus_0 + 1)},  x^{N_2+2}) \rightarrow (\Gamma^{(0,  r_2 \oplus_0 2)},  x^{N_2+3}).
$$
Из формулы \eqref{transitionToProve} и того факта,  что $h(\Gamma^{(0,  r_2 \oplus_0 1)},  x_3) = \Gamma^{(0,  r_2 \oplus_0 2 )}$,  следует
\begin{multline*}
\Pr( A_{N_1 + N_2 + 2} (0,  r_2 \oplus_0 2,  x^{N_2+3})
|A_{N_1 + N_2 + 1} (0,  r_2\oplus_0 1,  x^{N_2 + 2}) )
=\\
=\widetilde{\varphi}_3(0,  r_2 \oplus_0 2,  T^{(0,  r_2 \oplus_0 2)},  \min\{L,  \tilde{x}_3\},  \tilde{x}_3) 
\times \\ \times
\sum_{(a_1,  a_2)\in {\mathbb A}_{\mathrm{trans}}}\varphi_1(a_1,  T^{(0,  r_2 \oplus_0 2)}) \psi(a_2,  \tilde{x}_2+x_4,  p_{0,  r_2 \oplus_0  2}), 
\end{multline*}
где множество ${\mathbb A}_{\mathrm{trans}}$ не пусто и содержит,  как минимум,  один элемент
$$
(a_1,  a_2)=(\tilde{x}_1 + (1 - \delta_{\tilde{x}_1, 0})\ell(0,  r_2 \oplus_0 2,  1), \tilde{x}_2 + \ell(0,  r_2 \oplus_0 2,  2)),$$  поскольку из соотношений \eqref{A:trans:1}--\eqref{A:trans:2} имеем
\begin{align*}
{\mathbb A}_{\mathrm{trans}}&(x^{N_2+2},  x^{N_2+3},  0,  r_2 \oplus_0 2) = {\mathbb A}_{\mathrm{trans}}^0 \bigcap {\mathbb A}_{\mathrm{trans}}^1\bigcap {\mathbb A}_{\mathrm{trans}}^2, \\
{\mathbb A}_{\mathrm{trans}}^0 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon a_2 =\\
=&\min{\{\ell(0,  r_2 \oplus_0 2,  1),  a_1}\}   + \tilde{x}_2 - (1 - \delta_{\tilde{x}_1, 0})\ell(0, r_2 \oplus_0 2, 1) + \ell(0, r_2 \oplus_0 2, 2) \}, \\
{\mathbb A}_{\mathrm{trans}}^1 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon \tilde{x}_1 = \max{\{0,  a_1-\ell(0,  r_2 \oplus_0 2,  1)\}}\}, \\
{\mathbb A}_{\mathrm{trans}}^2 &= \{(a_1,  a_2) \in \mathbb{Z}_+^2 \colon  \tilde{x}_2 = \max{\{0,  a_2-\ell(0,  r_2 \oplus_0 2,  2)\}}\}.
\end{align*}
Из определений \eqref{tildephi} находим
\begin{multline*}
\widetilde{\varphi}_3(0, r_2 \oplus_0 2,  T^{(0, r_2 \oplus_0 2)},  x_{3,  N_2+2}, x_{3,  N_2+3})= \widetilde{\varphi}_3(0, r_2 \oplus_0 2,  T^{(0, r_2 \oplus_0 2)},  \min\{L,  \tilde{x}_3\},  \tilde{x}_3)=\\
= (1-\delta_{\tilde{x}_3,  0}) \times \varphi_3(\tilde{x} - \min\{L,  \tilde{x}_3\},  T^{(0,  0, r_2 \oplus_0 2)} ) + \delta_{\tilde{x}_3,  0} \varphi_3 (0,  T^{(0, r_2 \oplus_0 2)})  > 0.
\end{multline*}
И поскольку 
\begin{equation*}
\varphi_1(  \tilde{x}_1 + (1 - \delta_{\tilde{x}_1, 0})\ell(0,  r_2 \oplus_0 2,  1),  T^{(0,  r_2 \oplus_0 2)}) > 0, 
\end{equation*}
и 
\begin{equation*}
    \psi(\tilde{x}_2 + \ell(0,  r_2 \oplus_0 2,  2),  \tilde{x}_2 + \tilde{x}_4 - (1 - \delta_{\tilde{x}_1, 0})\ell(0, r_2 \oplus_0 2, 1) + \ell(0,  r_2 \oplus_0 2, 2),  p_{0,  r_2 \oplus_0 2}) > 0, 
\end{equation*}
то
\begin{multline*}
\Pr( A_{N_1 + N_2 + 2} (0,  r_2 \oplus_0 2,  x^{N_2+3})
|A_{N_1 + N_2+1} (0,  r_2 \oplus_0 1,  x^{N_2 + 2}) )
\geqslant \\
\geqslant \widetilde{\varphi}_3(0, r_2 \oplus_0 2,  T^{(0, r_2 \oplus_0 2)},  x_{3,  N_2 + 2}, x_{3,  N_2 + 3})
\times \\
\times \varphi_1(  \tilde{x}_1 + (1 - \delta_{\tilde{x}_1, 0})\ell(0,  r_2 \oplus_0 2,  1),  T^{(0,  r_2 \oplus_0 2)}) \times \\
\times \psi(\tilde{x}_2 + \ell(0,  r_2 \oplus_0 2,  2),  \tilde{x}_2 + \tilde{x}_4 - (1 - \delta_{\tilde{x}_1, 0})\ell(0, r_2 \oplus_0 2, 1) + \ell(0,  r_2 \oplus_0 2, 2),  p_{0,  r_2 \oplus_0 1})  > 0.
\end{multline*}
Этим заканчивается доказательство леммы.

\end{proof}
























\begin{lemma}
  Состояния вида $(\Gamma^{(0,  \tilde{r})},  \tilde{x}), $
  где $\tilde{x}$ таково,  что $\tilde{x}_1 \geqslant 0$,  $\tilde{x}_2\geqslant 0$,  а также
  $$
  \tilde{x}_3\hm\geqslant \max{}\Bigl\{0,  L+1\hm-\max\limits_{k=\overline{1,  d}}{\Bigl\{\sum\limits_{s=1}^{n_{\tilde{k}}} \ell(\tilde{k},  s,  3)\Bigr\}}\Bigr\}, 
  $$
  и
  $$
  \tilde{x}_4\hm\geqslant 0 и (x_1 > 0)\hm\Rightarrow (x_4 \geqslant \ell(0,  \tilde{r},  1)), 
  $$
  достижимы из состояний вида
  $$
  (\Gamma^{(0,  r_0)},  x^0),  x^0=(0,  0,  L+1,  0),  \Gamma^{(0,  r_0)} \in \Gamma.
  $$
\label{classification:arithm:7}
\end{lemma}

\begin{proof}
Из леммы~\eqref{classification:arithm:5} следует, что состояния вида $
(\Gamma^{(0,  \tilde{r})},  \tilde{\tilde{x}})$, где 
$$
\tilde{\tilde{x}}=(0,  0,  \tilde{x}_3,  0),  \tilde{x}_3\geqslant \max{\Big\{0,  L+1-\max_{k=\overline{1,  d}}{\Big\{ \sum_{s=1}^{n_k}\ell(k,  s,  3)\Big\}}\Big\}}, 
\tilde{r} = \overline{1,  n_0}, 
$$
достижимы из начального состояния  $(\Gamma^{(0,  r_0)},  x^0)$. 

Это, в свою очередь, по лемме~\eqref{classification:arithm:6} влечет достижимость конечных состояний $(\Gamma^{(0,  \tilde{r})},  \tilde{x})$.
\end{proof}

\begin{lemma}
  Состояния вида
  $$
  (\Gamma^{(0,  r_0)},  x^0), \quad  x_0=(0,  0,  L+1,  0),  r_0=\overline{1,  n_0}, 
  $$
достижимы из состояний вида $(\Gamma^{(\tilde{k},  \tilde{r})},  \tilde{x}), $
где $\tilde{k}=\overline{1,  d}$,  $\tilde{r} = \overline{1,  n_{\tilde{k}}}$ и $\tilde{x}$ таково,  что
$$
\tilde{x}_3\geqslant \max{\Bigl\{0,  L+1-\sum\limits_{s=1}^{\tilde{r}}\ell(\tilde{k},  s,  3)\Bigr\}}, 
$$
и 
$$
(\tilde{x}_1>0) \Rightarrow (\tilde{x}_4\geqslant \ell(\tilde{k},  \tilde{r}, 1)).
$$
\label{last:lemma}
\end{lemma}
\begin{proof}
Действительно,  из состояния $(\Gamma^{(0,  r_0)},  x^0)$ за конечное число $N_1$ шагов можно перейти в состояние $(\Gamma^{(0,  r_1)},  x^1)$,  $h_3(r_1)=\Gamma^{(\tilde{k},  \tilde{r})}$, 
\begin{align*}
x_{1,  1}&=0, & \quad x_{3,  1}&=\sum_{s=1}^{\tilde{r}} \ell(\tilde{k},  s, 3) +\tilde{x}_3\geqslant L+1,  \\
x_{2,  1}&=\sum_{s=1}^{\tilde{r}} \ell(\tilde{k},  s,  2) + \tilde{x}_2, & \quad x_{4,  1}&=\tilde{x}_4 -  (1- \delta_{\tilde{x}_1,  0}) \ell(\tilde{k},  \tilde{r},  1).
\end{align*}
На следующем такте цепь попадает в состояние цикла и далее за $\tilde{r}$ шагов попадает в конечное состояние. Полагая $N=N_1+\tilde{r}$,  получаем утверждение леммы.
\end{proof}

Из доказанных лемм~\ref{first:lemma}--\ref{last:lemma} следует теорема.
\begin{theorem}
Состояния вида
$(\Gamma^{(\tilde{k}, \tilde{r})}, \tilde{x})$, 
где $\tilde{k}=\overline{0, d}$,  $\tilde{r} = \overline{1, n_{\tilde{k}}}$,  $\tilde{x}\in \mathbb{Z}_+^4$, 
\begin{gather}
(\tilde{x}_1>0) \Rightarrow (\tilde{x}_4\geqslant \ell(\tilde{k}, \tilde{r}, 1)), \label{reachable:1}\\
\tilde{x}_3\geqslant \max{\Bigl\{0, L+1-\sum_{s=1}^{\tilde{r}}\ell(k, s, 3)\Bigr\}},  \text{ если } \tilde{k}>0, \\
\tilde{x}_3\geqslant \max{\Big\{0, L+1-\max_{k=\overline{1, d}}{\{\sum_{s=1}^{n_{\tilde{k}}} \ell(\tilde{k}, s, 3)\}}\Bigr\}},  \text{ если } \tilde{k}=0, \label{reachable:2}
\end{gather}
 и только они достижимы из состояния 
 $$
 (\Gamma^{(0,  r_0)},  x^0),  \quad x^0=(0,  0,  L+1,  0),  \quad r_0=\overline{1, n_0}, 
 $$ и,  следовательно,  являются существенными.
 \label{important:states:basic}
\end{theorem}
\begin{proof}
Существенность состояний уже доказана в леммах~\ref{first:lemma}--\ref{last:lemma}, поэтому осталось доказать отсутствие других существенных состояний.

Покажем сначала,  что состояния $(\Gamma^{(k, r)}, x)$,  $\Gamma^{(k, r)}\in \Gamma$,  $x\in Z^4_+$,  для которых 
\begin{equation*}
    \ell(k, r, 1) > 0, \quad x_1>0,  \quad x_4 < \ell(k, r, 1), 
\end{equation*}
являются несущественными. Действительно,  пусть $\varkappa_{1, i+1}=x_1 > 0$,  тогда из равенства \eqref{queuesFunc} следует
\begin{multline*}
    \varkappa_{1,  i+1} = \max \{0; \varkappa_{1,  i} + \eta_{1,  i}-\xi_{1,  i}\} > 0 \implies \\ 
    \implies \varkappa_{1,  i} + \eta_{1,  i}-\xi_{1,  i} > 0 \implies  \varkappa_{1,  i} + \eta_{1,  i} > \xi_{1,  i}.
\end{multline*}
С другой стороны $\varkappa_{4,  i+1} < \ell(k,  r,  1)$ и учитывая \eqref{FourthFunc} имеем 
\begin{multline*}
    \varkappa_{4,  i+1} = \varkappa_{4,  i} + \eta_{4,  i} - \eta_{2,  i} =  \varkappa_{4,  i} + \min\{\xi_{1,  i}; \varkappa_{1,  i}+\eta_{1,  i}\} - \eta_{2,  i}  < \ell(k,  r,  1) = \xi_{1,  i}, 
\end{multline*}
то есть 
\begin{equation*}
     \varkappa_{4,  i} + \min\{\xi_{1,  i}; \varkappa_{1,  i}+\eta_{1,  i}\} - \eta_{2,  i} < \xi_{1,  i} \implies      \varkappa_{4, i} + \xi_{1,  i}- \eta_{2,  i} < \xi_{1,  i} \implies  \varkappa_{4,  i} < \eta_{2,  i}.
\end{equation*}
Однако это противоречит теореме~\eqref{myTheorem},  поскольку вероятность того,  что по второму потоку поступит больше требований,  чем находилось на начало такта в очереди $O_4$,  равна нулю.

Рассмотрим теперь вопрос о несущественности состояний вида $(\Gamma^{(k,  r)},  x)$,  $\Gamma^{(k,  r)}\in \Gamma$,  $x\in Z^4_+$,  для которых 
\begin{equation*}
    x_3< L + 1 - \sum_{s=1}^r \ell(k, s, 3).
\end{equation*}
Пусть $\varkappa_{3,  i+r}=x_3 < L + 1 - \sum_{s=1}^r \ell(k,  s,  3)$. тогда из равенств \eqref{queuesFunc} следует цепочка неравенств:
\begin{equation*}
    \varkappa_{3, i+r} \geqslant \varkappa_{3,  i+r-1} - \xi_{3,  i+r-1} \geqslant \varkappa_{3,  i+r-2} - \xi_{3,  i+r-1}- \xi_{3,  i+r-2} \geqslant \varkappa_{3,  i} - \sum_{s=1}^r \ell(k,  s,  3).
\end{equation*}
То есть $\varkappa_{3,  i} < L + 1$. То есть при переходе от шага $i$ к шагу  $i+1$ количество требований в очереди $O_3$ не превышает порога $L$ и должно включиться состояние продления. Однако мы исходили из предположения,  что следующие $r$ состояний соответствуют циклу с номером $k$. Приходим к противоречию и,  следовательно,  прийти в состояние c $x_3< L + 1 - \sum_{s=1}^r \ell(k,  s,  3)$ невозможно.
\end{proof}

Пусть
\begin{align*}
  S^3_{0, r} = & 
  \Bigl\{
  (\Gamma^{(0,  r)},  x_3) \colon \; x_3\in Z_+, \; x_3 > L - \max\limits_{k=1,  2, 
    \ldots,  d}
  \Bigl\{ \sum_{t=1}^{n_k} \ell({k,  t,  3}) \Bigl\}\Bigl\},  
  \quad 1 \leqslant r \leqslant n_0,  \\
  S^3_{k,  r} = & 
  \Bigl\{
  (\Gamma^{(k,  r)},  x_3) \colon \; x_3\in Z_+, \; x_3 > L - \sum_{t=1}^{r} \ell({k,  t,  3})
  \Bigr\},  
  \quad 1 \leqslant k \leqslant d,  \quad 1 \leqslant r \leqslant n_k.
\end{align*}


Из доказанных лемм~\ref{first:lemma}--\ref{last:lemma} также следует другая теорема.
\begin{theorem}
Множество существенных состояний марковской цепи $\MarkThree$ имеет вид
\begin{equation}
S^{3} = \raisebox{-.5ex}{$\Bigl($}\bigcup\limits_{1 \leqslant r \leqslant n_0}S^3_{0, r}\raisebox{-.5ex}{$\Bigr)$}\cup \raisebox{-.5ex}{$\Bigl($}\bigcup\limits_{\substack{1 \leqslant k \leqslant d\\ 1 \leqslant r \leqslant n_k}} S^3_{k, r}\raisebox{-.5ex}{$\Bigr)$}.
\label{important:states:three:expr}
\end{equation}
\label{important:states:three}
\end{theorem}

Таким образом, теорема~\ref{important:states:basic} описывает множество существенных состояний для основной марковской цепи $\Mark$, а теорема~\ref{important:states:three}~--- для марковской цепи $\MarkThree$. 




